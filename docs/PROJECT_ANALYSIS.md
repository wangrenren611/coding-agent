# Coding Agent é¡¹ç›®æ·±åº¦åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2026-02-25  
**åˆ†æå·¥å…·**: Claude Code (explore subagent)

---

## ç›®å½•

1. [é¡¹ç›®ç»“æ„åˆ†æ](#1-é¡¹ç›®ç»“æ„åˆ†æ)
2. [é€æ–‡ä»¶åˆ†æ](#2-é€æ–‡ä»¶åˆ†æ)
3. [æ¶æ„ç†è§£](#3-æ¶æ„ç†è§£)
4. [ä¾èµ–åˆ†æ](#4-ä¾èµ–åˆ†æ)
5. [è®¾è®¡ç‰¹ç‚¹æ€»ç»“](#5-è®¾è®¡ç‰¹ç‚¹æ€»ç»“)

---

## 1. é¡¹ç›®ç»“æ„åˆ†æ

### 1.1 å®Œæ•´ç›®å½•ç»“æ„

```
/Users/wrr/work/coding-agent/
â”œâ”€â”€ ğŸ“„ é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ package.json              # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”‚   â”œâ”€â”€ tsconfig.json             # TypeScript é…ç½®
â”‚   â”œâ”€â”€ tsup.config.ts            # æ„å»ºå·¥å…·é…ç½®
â”‚   â”œâ”€â”€ vitest.config.ts          # æµ‹è¯•æ¡†æ¶é…ç½®
â”‚   â”œâ”€â”€ eslint.config.js          # ä»£ç è§„èŒƒé…ç½®
â”‚   â””â”€â”€ pnpm-lock.yaml            # ä¾èµ–é”å®šæ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“š æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md                 # é¡¹ç›®æ–‡æ¡£ï¼ˆä¸­æ–‡ï¼‰
â”‚   â”œâ”€â”€ docs/                     # è¯¦ç»†æ–‡æ¡£ç›®å½•
â”‚   â”‚   â”œâ”€â”€ ARCHITECTURE.md       # æ¶æ„æ–‡æ¡£
â”‚   â”‚   â”œâ”€â”€ EXECUTION_FLOW.md     # æ‰§è¡Œæµç¨‹
â”‚   â”‚   â”œâ”€â”€ IMPLEMENTATION.md     # å®ç°ç»†èŠ‚
â”‚   â”‚   â””â”€â”€ PRODUCT.md            # äº§å“æ–‡æ¡£
â”‚   â””â”€â”€ claude-blog-summaries/    # Claude åšå®¢æ‘˜è¦
â”‚
â”œâ”€â”€ ğŸ’» æºä»£ç  (src/)
â”‚   â”œâ”€â”€ agent-v2/                 # Agent v2 æ ¸å¿ƒå®ç°
â”‚   â”‚   â”œâ”€â”€ agent/                # Agent å¼•æ“
â”‚   â”‚   â”‚   â”œâ”€â”€ core/             # æ ¸å¿ƒç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ agent-state.ts      # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ llm-caller.ts       # LLM è°ƒç”¨å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tool-executor.ts    # å·¥å…·æ‰§è¡Œå™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ retry-strategy.ts   # é‡è¯•ç­–ç•¥
â”‚   â”‚   â”‚   â”œâ”€â”€ agent.ts              # Agent ä¸»ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ agent-emitter.ts      # äº‹ä»¶å‘å°„å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts              # ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ errors.ts             # é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ stream-processor.ts   # æµå¼å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ message-builder.ts    # æ¶ˆæ¯æ„å»º
â”‚   â”‚   â”‚   â”œâ”€â”€ response-validator.ts # å“åº”éªŒè¯
â”‚   â”‚   â”‚   â””â”€â”€ input-validator.ts    # è¾“å…¥éªŒè¯
â”‚   â”‚   â”œâ”€â”€ session/              # ä¼šè¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ session.ts            # Session ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ compaction.ts         # ä¸Šä¸‹æ–‡å‹ç¼©
â”‚   â”‚   â”‚   â””â”€â”€ tool-call-repairer.ts # å·¥å…·è°ƒç”¨ä¿®å¤
â”‚   â”‚   â”œâ”€â”€ memory/               # æŒä¹…åŒ–å­˜å‚¨
â”‚   â”‚   â”‚   â””â”€â”€ file-memory.ts        # æ–‡ä»¶å­˜å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ tool/                 # å·¥å…·ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ base.ts               # å·¥å…·åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ registry.ts           # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ bash.ts               # Bash å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ file.ts               # æ–‡ä»¶å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ grep.ts               # æœç´¢å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ glob.ts               # æ–‡ä»¶åŒ¹é…
â”‚   â”‚   â”‚   â”œâ”€â”€ surgical.ts           # ç²¾ç¡®ç¼–è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ batch-replace.ts      # æ‰¹é‡æ›¿æ¢
â”‚   â”‚   â”‚   â”œâ”€â”€ lsp.ts                # LSP æ”¯æŒ
â”‚   â”‚   â”‚   â”œâ”€â”€ web-search.ts         # ç½‘ç»œæœç´¢
â”‚   â”‚   â”‚   â”œâ”€â”€ web-fetch.ts          # ç½‘é¡µæŠ“å–
â”‚   â”‚   â”‚   â””â”€â”€ task/                 # ä»»åŠ¡ç®¡ç†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ eventbus/             # äº‹ä»¶æ€»çº¿
â”‚   â”‚   â”œâ”€â”€ prompts/              # æç¤ºè¯æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ security/             # å®‰å…¨æ¨¡å—
â”‚   â”‚   â””â”€â”€ util/                 # å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/                # LLM Provider å±‚
â”‚   â”‚   â”œâ”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ registry.ts           # Provider æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ openai-compatible.ts  # OpenAI å…¼å®¹ Provider
â”‚   â”‚   â”œâ”€â”€ adapters/             # API é€‚é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ base.ts
â”‚   â”‚   â”‚   â””â”€â”€ standard.ts
â”‚   â”‚   â”œâ”€â”€ http/                 # HTTP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”‚   â””â”€â”€ stream-parser.ts
â”‚   â”‚   â””â”€â”€ types/                # ç±»å‹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ agent-chat-react/         # React Hooks
â”‚   â”‚   â”œâ”€â”€ use-agent-chat.ts
â”‚   â”‚   â”œâ”€â”€ reducer.ts
â”‚   â”‚   â””â”€â”€ context.tsx
â”‚   â”‚
â”‚   â””â”€â”€ cli/                      # CLI åº”ç”¨
â”‚       â”œâ”€â”€ run.tsx
â”‚       â”œâ”€â”€ app.tsx
â”‚       â””â”€â”€ components/
â”‚
â”œâ”€â”€ ğŸ§ª æµ‹è¯•ç›¸å…³
â”‚   â”œâ”€â”€ test-agent/               # æµ‹è¯•é€‚é…å™¨
â”‚   â””â”€â”€ src/**/*.test.ts          # å•å…ƒæµ‹è¯•
â”‚
â”œâ”€â”€ ğŸ“¦ åº”ç”¨ (apps/)
â”‚   â”œâ”€â”€ agent-cli-ink/            # CLI åº”ç”¨ v1
â”‚   â””â”€â”€ agent-cli-ink-v2/         # CLI åº”ç”¨ v2
â”‚
â”œâ”€â”€ ğŸ’¾ æ•°æ®ç›®å½• (data/)
â”‚   â””â”€â”€ agent-memory/             # ä¼šè¯æ•°æ®å­˜å‚¨
â”‚
â””â”€â”€ ğŸ“– TypeScript ç»ƒä¹  (typescript/)
    â””â”€â”€ exercises/                # ç¼–ç¨‹ç»ƒä¹ é¢˜
```

### 1.2 é¡¹ç›®ç±»å‹è¯†åˆ«

**é¡¹ç›®ç±»å‹**: TypeScript/Node.js é¡¹ç›®

**æŠ€æœ¯æ ˆ**:
- **è¯­è¨€**: TypeScript 5.3+
- **è¿è¡Œæ—¶**: Node.js 20+
- **åŒ…ç®¡ç†å™¨**: pnpm
- **æ„å»ºå·¥å…·**: tsup
- **æµ‹è¯•æ¡†æ¶**: Vitest
- **UI æ¡†æ¶**: React 19 (ç”¨äº CLI)
- **ç»ˆç«¯ UI**: @opentui (Ink æ›¿ä»£å“)

### 1.3 ä¸»è¦é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `package.json` | é¡¹ç›®å…ƒæ•°æ®ã€ä¾èµ–ã€è„šæœ¬ |
| `tsconfig.json` | TypeScript ç¼–è¯‘é…ç½® |
| `tsup.config.ts` | æ‰“åŒ…æ„å»ºé…ç½® |
| `vitest.config.ts` | æµ‹è¯•æ¡†æ¶é…ç½® |
| `eslint.config.js` | ä»£ç  lint è§„åˆ™ |

---

## 2. é€æ–‡ä»¶åˆ†æ

### 2.1 æ ¸å¿ƒ Agent æ¨¡å—

#### `src/agent-v2/agent/agent.ts` - Agent ä¸»ç±»

**èŒè´£**: åè°ƒå™¨æ¨¡å¼çš„æ ¸å¿ƒï¼Œç®¡ç†ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

**ä¸»è¦åŠŸèƒ½**:
1. **ä»»åŠ¡æ‰§è¡Œ**: `execute()`, `executeWithResult()`
2. **çŠ¶æ€ç®¡ç†**: é€šè¿‡ `AgentState` ç®¡ç†
3. **é”™è¯¯å¤„ç†**: è‡ªåŠ¨é‡è¯•ã€é”™è¯¯åˆ†ç±»
4. **äº‹ä»¶å‘å°„**: é€šè¿‡ `EventBus` å’Œ `AgentEmitter`

**å…³é”®æ–¹æ³•**:
```typescript
// æ‰§è¡Œä»»åŠ¡
async execute(query: MessageContent, options?: LLMGenerateOptions): Promise<Message>

// æ‰§è¡Œå¹¶è¿”å›è¯¦ç»†ç»“æœ
async executeWithResult(query, options?): Promise<AgentExecutionResult>

// ä¸­æ­¢ä»»åŠ¡
abort(): void

// äº‹ä»¶è®¢é˜…
on(type: EventType, listener): void
off(type: EventType, listener): void
```

**ä¾èµ–å…³ç³»**:
- `AgentState` - çŠ¶æ€ç®¡ç†
- `LLMCaller` - LLM è°ƒç”¨
- `ToolExecutor` - å·¥å…·æ‰§è¡Œ
- `Session` - ä¼šè¯ç®¡ç†
- `EventBus` - äº‹ä»¶æ€»çº¿

---

#### `src/agent-v2/agent/core/agent-state.ts` - çŠ¶æ€ç®¡ç†å™¨

**èŒè´£**: ç»Ÿä¸€ç®¡ç† Agent æ‰§è¡ŒçŠ¶æ€

**çŠ¶æ€ç±»å‹**:
```typescript
enum AgentStatus {
    IDLE = 'idle',           // ç©ºé—²
    RUNNING = 'running',     // è¿è¡Œä¸­
    THINKING = 'thinking',   // æ€è€ƒä¸­
    RETRYING = 'retrying',   // é‡è¯•ä¸­
    COMPLETED = 'completed', // å·²å®Œæˆ
    FAILED = 'failed',       // å·²å¤±è´¥
    ABORTED = 'aborted',     // å·²ä¸­æ­¢
}
```

**æ ¸å¿ƒæ–¹æ³•**:
- `canContinue()` - æ£€æŸ¥æ˜¯å¦å¯ç»§ç»­
- `isRetryExceeded()` - æ£€æŸ¥é‡è¯•è¶…é™
- `recordSuccess()` / `recordRetryableError()` - è®°å½•æ‰§è¡Œç»“æœ
- `abort()` - ä¸­æ­¢ä»»åŠ¡

---

#### `src/agent-v2/agent/core/llm-caller.ts` - LLM è°ƒç”¨å™¨

**èŒè´£**: å°è£… LLM è°ƒç”¨ï¼Œæ”¯æŒæµå¼å’Œéæµå¼

**å…³é”®ç‰¹æ€§**:
1. **æµå¼å¤„ç†**: é€šè¿‡ `StreamProcessor` å¤„ç†å¢é‡å“åº”
2. **è¶…æ—¶æ§åˆ¶**: æ”¯æŒè¯·æ±‚è¶…æ—¶å’Œ abort ä¿¡å·
3. **å›è°ƒæœºåˆ¶**: æ–‡æœ¬/æ¨ç†/å·¥å…·è°ƒç”¨çš„äº‹ä»¶å›è°ƒ

**é…ç½®é€‰é¡¹**:
```typescript
interface LLMCallerConfig {
    provider: LLMProvider;
    stream: boolean;
    maxBufferSize: number;
    requestTimeoutMs?: number;
    thinking?: boolean;
    // ... å„ç§å›è°ƒ
}
```

---

#### `src/agent-v2/agent/core/tool-executor.ts` - å·¥å…·æ‰§è¡Œå™¨

**èŒè´£**: æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼Œå¤„ç†ç»“æœ

**å…³é”®åŠŸèƒ½**:
1. **å·¥å…·æ‰§è¡Œ**: è°ƒç”¨ `ToolRegistry.execute()`
2. **ç»“æœè®°å½•**: åˆ›å»ºå·¥å…·ç»“æœæ¶ˆæ¯
3. **ä»£ç è¡¥ä¸**: ç”Ÿæˆæ–‡ä»¶å˜æ›´çš„ diff
4. **å®‰å…¨è„±æ•**: ä½¿ç”¨ `sanitizeToolResultUtil()`

**æ–‡ä»¶å¿«ç…§æœºåˆ¶**:
- æ‰§è¡Œå‰æ•è·æ–‡ä»¶çŠ¶æ€
- æ‰§è¡Œåç”Ÿæˆ unified diff
- æ”¯æŒä»£ç è¡¥ä¸å›è°ƒ

---

### 2.2 ä¼šè¯ç®¡ç†æ¨¡å—

#### `src/agent-v2/session/session.ts` - Session ç±»

**èŒè´£**: ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡å’Œæ¶ˆæ¯

**æ ¸å¿ƒåŠŸèƒ½**:
1. **æ¶ˆæ¯ç®¡ç†**: å¢åˆ æ”¹æŸ¥æ¶ˆæ¯
2. **æŒä¹…åŒ–**: é€šè¿‡ `MemoryManager` ä¿å­˜
3. **ä¸Šä¸‹æ–‡å‹ç¼©**: è‡ªåŠ¨å‹ç¼©é•¿å¯¹è¯
4. **å·¥å…·è°ƒç”¨ä¿®å¤**: ä¿®å¤ä¸­æ–­çš„ tool call

**å…³é”®æ–¹æ³•**:
```typescript
// åˆå§‹åŒ–ï¼ˆåŠ è½½å†å²æˆ–åˆ›å»ºæ–°ä¼šè¯ï¼‰
async initialize(): Promise<void>

// æ·»åŠ æ¶ˆæ¯
addMessage(message: Message): string

// LLM è°ƒç”¨å‰å‹ç¼©æ£€æŸ¥
async compactBeforeLLMCall(): Promise<boolean>

// åŒæ­¥åˆ°å­˜å‚¨
async sync(): Promise<void>
```

---

#### `src/agent-v2/session/compaction.ts` - ä¸Šä¸‹æ–‡å‹ç¼©

**èŒè´£**: æ™ºèƒ½å‹ç¼©å¯¹è¯ä¸Šä¸‹æ–‡ï¼ŒèŠ‚çœ token

**å‹ç¼©ç­–ç•¥**:
- ä¿ç•™æœ€è¿‘çš„ N æ¡æ¶ˆæ¯
- å°†æ—§æ¶ˆæ¯å‹ç¼©ä¸ºæ‘˜è¦
- ä½¿ç”¨ LLM ç”Ÿæˆæ‘˜è¦

**è§¦å‘æ¡ä»¶**:
- Token æ•°é‡è¶…è¿‡é˜ˆå€¼
- è¾¾åˆ°é…ç½®çš„è§¦å‘æ¯”ä¾‹

---

### 2.3 å·¥å…·ç³»ç»Ÿ

#### `src/agent-v2/tool/base.ts` - å·¥å…·åŸºç±»

**æŠ½è±¡ç±»å®šä¹‰**:
```typescript
abstract class BaseTool<T extends z.ZodType> {
    abstract name: string;
    abstract description: string;
    abstract schema: T;
    executionTimeoutMs?: number | null;
    
    abstract execute(args?: z.infer<T>, context?: ToolContext): Promise<ToolResult>;
}
```

**å·¥å…·ç»“æœæ¥å£**:
```typescript
interface ToolResult<T = unknown> {
    success: boolean;
    metadata?: T;
    error?: string;
    output?: string;
}
```

---

#### `src/agent-v2/tool/registry.ts` - å·¥å…·æ³¨å†Œè¡¨

**èŒè´£**: å·¥å…·æ³¨å†Œã€æ‰§è¡Œã€è¶…æ—¶æ§åˆ¶

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
// æ³¨å†Œå·¥å…·
register(tools: BaseTool[]): void

// æ‰§è¡Œå·¥å…·è°ƒç”¨
async execute(toolCalls: ToolCall[], context?): Promise<...>

// è½¬æ¢ä¸º LLM å·¥å…·æ ¼å¼
toLLMTools(): Array<ToolSchema>
```

**è¶…æ—¶æ§åˆ¶**:
- é»˜è®¤ 5 åˆ†é’Ÿè¶…æ—¶
- æ”¯æŒå·¥å…·è‡ªå®šä¹‰è¶…æ—¶
- ä½¿ç”¨ `setTimeout/clearTimeout` é˜²æ­¢å†…å­˜æ³„æ¼

---

#### å†…ç½®å·¥å…·åˆ—è¡¨

| å·¥å…· | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| `BashTool` | `bash.ts` | Shell å‘½ä»¤æ‰§è¡Œ |
| `ReadFileTool` | `file.ts` | è¯»å–æ–‡ä»¶ |
| `WriteFileTool` | `file.ts` | å†™å…¥æ–‡ä»¶ |
| `SurgicalEditTool` | `surgical.ts` | ç²¾ç¡®æ–‡æœ¬æ›¿æ¢ |
| `BatchReplaceTool` | `batch-replace.ts` | æ‰¹é‡æ›¿æ¢ |
| `GrepTool` | `grep.ts` | æ­£åˆ™æœç´¢ |
| `GlobTool` | `glob.ts` | æ–‡ä»¶æ¨¡å¼åŒ¹é… |
| `LspTool` | `lsp.ts` | è¯­è¨€æœåŠ¡å™¨åè®® |
| `WebSearchTool` | `web-search.ts` | ç½‘ç»œæœç´¢ |
| `WebFetchTool` | `web-fetch.ts` | ç½‘é¡µæŠ“å– |
| `Task*` | `task/` | å­ä»»åŠ¡ç®¡ç† |

---

### 2.4 æŒä¹…åŒ–å­˜å‚¨

#### `src/agent-v2/memory/file-memory.ts` - æ–‡ä»¶å­˜å‚¨

**è®¾è®¡ç›®æ ‡**:
1. å†™æ“ä½œç«‹å³è½ç›˜
2. åŸå­å†™ + å¤‡ä»½æ¢å¤
3. ä¸Šä¸‹æ–‡ä¸å†å²ä¿æŒä¸€è‡´

**å­˜å‚¨ç»“æ„**:
```
data/agent-memory/
â”œâ”€â”€ sessions/           # ä¼šè¯å…ƒæ•°æ®
â”œâ”€â”€ contexts/           # å½“å‰ä¸Šä¸‹æ–‡
â”œâ”€â”€ histories/          # å®Œæ•´å†å²
â”œâ”€â”€ compactions/        # å‹ç¼©è®°å½•
â”œâ”€â”€ tasks/              # ä»»åŠ¡æ•°æ®
â””â”€â”€ subtask-runs/       # å­ä»»åŠ¡è¿è¡Œ
```

**å…³é”®ç‰¹æ€§**:
- **åŸå­å†™å…¥**: å…ˆå†™ä¸´æ—¶æ–‡ä»¶ï¼Œå† rename
- **å¤‡ä»½æ¢å¤**: æŸåæ—¶ä» .bak æ¢å¤
- **æ–‡ä»¶é˜Ÿåˆ—**: é˜²æ­¢å¹¶å‘å†™å…¥å†²çª
- **Windows å…¼å®¹**: EPERM é”™è¯¯é‡è¯•

---

### 2.5 Provider å±‚

#### `src/providers/index.ts` - Provider ç»Ÿä¸€å¯¼å‡º

**æ”¯æŒçš„ Provider**:
- GLM (æ™ºè°±)
- Kimi (æœˆä¹‹æš—é¢)
- MiniMax
- OpenAI Compatible

**æ ¸å¿ƒæ¥å£**:
```typescript
interface LLMProvider {
    getModel(): string;
    getTimeTimeout(): number;
    generate(messages, tools?, options?): Promise<LLMResponse>;
    generateStream?(...): AsyncIterable<LLMStreamChunk>;
}
```

---

### 2.6 äº‹ä»¶ç³»ç»Ÿ

#### `src/agent-v2/eventbus/eventbus.ts` - äº‹ä»¶æ€»çº¿

**å®ç°**: ç®€å•çš„å‘å¸ƒè®¢é˜…æ¨¡å¼

**äº‹ä»¶ç±»å‹**:
```typescript
enum EventType {
    TASK_START = 'task:start',
    TASK_PROGRESS = 'task:progress',
    TASK_SUCCESS = 'task:success',
    TASK_FAILED = 'task:failed',
    TASK_RETRY = 'task:retry',
    TOOL_START = 'tool:start',
    TOOL_SUCCESS = 'tool:success',
    TOOL_FAILED = 'tool:failed',
}
```

---

## 3. æ¶æ„ç†è§£

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚ (Application)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   CLI (Ink)     â”‚  â”‚  React Hooks    â”‚  â”‚   è‡ªå®šä¹‰åº”ç”¨     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Agent åè°ƒå™¨ (Coordinator)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  AgentState  â”‚  â”‚   Emitter    â”‚  â”‚  EventBus    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLMCaller     â”‚  â”‚  ToolExecutor   â”‚  â”‚     Session     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Stream   â”‚  â”‚  â”‚  â”‚  Registry â”‚  â”‚  â”‚  â”‚ Compactionâ”‚  â”‚
â”‚  â”‚ Processor â”‚  â”‚  â”‚  â”‚           â”‚  â”‚  â”‚  â”‚           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚                   â”‚
          â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Provider     â”‚  â”‚     Tools       â”‚  â”‚ MemoryManager   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTTP     â”‚  â”‚  â”‚  â”‚  Bash     â”‚  â”‚  â”‚  â”‚  File     â”‚  â”‚
â”‚  â”‚  Client   â”‚  â”‚  â”‚  â”‚  File     â”‚  â”‚  â”‚  â”‚  Storage  â”‚  â”‚
â”‚  â”‚           â”‚  â”‚  â”‚  â”‚  Grep     â”‚  â”‚  â”‚  â”‚           â”‚  â”‚
â”‚  â”‚  GLM      â”‚  â”‚  â”‚  â”‚  Web      â”‚  â”‚  â”‚  â”‚           â”‚  â”‚
â”‚  â”‚  Kimi     â”‚  â”‚  â”‚  â”‚  LSP      â”‚  â”‚  â”‚  â”‚           â”‚  â”‚
â”‚  â”‚  MiniMax  â”‚  â”‚  â”‚  â”‚  Task     â”‚  â”‚  â”‚  â”‚           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæ¨¡å—å’Œç»„ä»¶

| æ¨¡å— | ç»„ä»¶ | èŒè´£ |
|------|------|------|
| **Agent** | `Agent`, `AgentState` | åè°ƒå™¨ï¼Œä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| **LLM** | `LLMCaller`, `StreamProcessor` | LLM è°ƒç”¨ï¼Œæµå¼å¤„ç† |
| **å·¥å…·** | `ToolRegistry`, `ToolExecutor`, `BaseTool` | å·¥å…·æ³¨å†Œã€æ‰§è¡Œ |
| **ä¼šè¯** | `Session`, `Compaction` | æ¶ˆæ¯ç®¡ç†ï¼Œä¸Šä¸‹æ–‡å‹ç¼© |
| **å­˜å‚¨** | `FileMemoryManager` | æŒä¹…åŒ–å­˜å‚¨ |
| **äº‹ä»¶** | `EventBus`, `AgentEmitter` | äº‹ä»¶å‘å¸ƒè®¢é˜… |
| **Provider** | `LLMProvider`, `HTTPClient` | LLM API å°è£… |

### 3.3 æ•°æ®æµå’Œæ§åˆ¶æµ

**æ‰§è¡Œæµç¨‹**:
```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent.run() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸»å¾ªç¯                              â”‚
â”‚  1. æ£€æŸ¥ abort çŠ¶æ€                                      â”‚
â”‚  2. æ£€æŸ¥é‡è¯•çŠ¶æ€                                         â”‚
â”‚  3. æ£€æŸ¥æ˜¯å¦å®Œæˆ                                         â”‚
â”‚  4. è§¦å‘ä¸Šä¸‹æ–‡å‹ç¼©ï¼ˆå¦‚éœ€è¦ï¼‰                              â”‚
â”‚  5. è°ƒç”¨ LLM (LLMCaller)                                â”‚
â”‚  6. å¤„ç†å“åº”                                             â”‚
â”‚     â”œâ”€ æ–‡æœ¬å“åº” â†’ æ£€æŸ¥å®Œæˆ                               â”‚
â”‚     â””â”€ å·¥å…·è°ƒç”¨ â†’ æ‰§è¡Œå·¥å…· (ToolExecutor)               â”‚
â”‚  7. é”™è¯¯å¤„ç†ä¸é‡è¯•                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›æœ€ç»ˆæ¶ˆæ¯/ç»“æœ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 è®¾è®¡æ¨¡å¼

| æ¨¡å¼ | åº”ç”¨ä½ç½® | è¯´æ˜ |
|------|----------|------|
| **åè°ƒå™¨æ¨¡å¼** | `Agent` ç±» | Agent ä½œä¸ºåè°ƒå™¨ï¼Œå§”æ‰˜å·¥ä½œç»™ä¸“ä¸šç»„ä»¶ |
| **ç­–ç•¥æ¨¡å¼** | `LLMProvider` | ä¸åŒ Provider å¯äº’æ¢ |
| **è§‚å¯Ÿè€…æ¨¡å¼** | `EventBus` | äº‹ä»¶å‘å¸ƒè®¢é˜… |
| **å·¥å‚æ¨¡å¼** | `createDefaultToolRegistry` | åˆ›å»ºå·¥å…·æ³¨å†Œè¡¨ |
| **æ¨¡æ¿æ–¹æ³•** | `BaseTool` | å·¥å…·åŸºç±»å®šä¹‰æ‰§è¡Œæ¡†æ¶ |
| **å•ä¾‹æ¨¡å¼** | é…ç½®å¯¹è±¡ | å…±äº«é…ç½® |

---

## 4. ä¾èµ–åˆ†æ

### 4.1 ç”Ÿäº§ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| `@opentui/core` | ^0.1.80 | ç»ˆç«¯ UI æ ¸å¿ƒ |
| `@opentui/react` | ^0.1.80 | React ç»ˆç«¯ UI |
| `@tavily/core` | ^0.7.1 | Tavily æœç´¢ API |
| `@vscode/ripgrep` | ^1.17.0 | ä»£ç æœç´¢ |
| `agent-browser` | ^0.9.0 | Agent æµè§ˆå™¨ |
| `dotenv` | ^17.2.3 | ç¯å¢ƒå˜é‡åŠ è½½ |
| `execa` | ^9.6.1 | å­è¿›ç¨‹æ‰§è¡Œ |
| `fast-glob` | ^3.3.3 | æ–‡ä»¶åŒ¹é… |
| `iconv-lite` | ^0.7.2 | ç¼–ç è½¬æ¢ |
| `isbinaryfile` | ^5.0.7 | äºŒè¿›åˆ¶æ–‡ä»¶æ£€æµ‹ |
| `react` | ^19.2.4 | React æ¡†æ¶ |
| `react-dom` | ^19.2.4 | React DOM |
| `shell-quote` | ^1.8.3 | Shell å‘½ä»¤è§£æ |
| `strip-ansi` | ^7.1.2 | ANSI ç ç§»é™¤ |
| `turndown` | ^7.2.2 | HTML è½¬ Markdown |
| `uuid` | ^11.1.0 | UUID ç”Ÿæˆ |
| `zod` | ^4.3.6 | Schema éªŒè¯ |

### 4.2 å¼€å‘ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| `@eslint/js` | ^9.39.2 | ESLint é…ç½® |
| `@types/node` | ^25.2.0 | Node.js ç±»å‹ |
| `@types/react` | ^19.0.6 | React ç±»å‹ |
| `@vitest/ui` | ^4.0.18 | Vitest UI |
| `chalk` | ^5.4.1 | ç»ˆç«¯é¢œè‰² |
| `cross-env` | ^10.1.0 | è·¨å¹³å°ç¯å¢ƒå˜é‡ |
| `eslint` | ^9.39.2 | ä»£ç æ£€æŸ¥ |
| `tsup` | ^8.4.0 | æ‰“åŒ…å·¥å…· |
| `tsx` | ^4.21.0 | TypeScript æ‰§è¡Œ |
| `typescript` | ^5.3.3 | TypeScript ç¼–è¯‘å™¨ |
| `vitest` | ^4.0.18 | æµ‹è¯•æ¡†æ¶ |

---

## 5. è®¾è®¡ç‰¹ç‚¹æ€»ç»“

### 5.1 æ¶æ„ç‰¹ç‚¹

1. **åè°ƒå™¨æ¨¡å¼**: Agent ä½œä¸ºæ ¸å¿ƒåè°ƒå™¨ï¼Œå°†å¤æ‚é€»è¾‘åˆ†è§£ä¸ºç‹¬ç«‹ç»„ä»¶
2. **å¯æ’æ‹”è®¾è®¡**: Providerã€å·¥å…·ã€å­˜å‚¨å‡å¯ç‹¬ç«‹æ‰©å±•
3. **äº‹ä»¶é©±åŠ¨**: é€šè¿‡ EventBus è§£è€¦ç»„ä»¶é—´é€šä¿¡
4. **ç±»å‹å®‰å…¨**: TypeScript ä¸¥æ ¼æ¨¡å¼ï¼Œå®Œæ•´çš„ç±»å‹å®šä¹‰
5. **æµå¼ä¼˜å…ˆ**: åŸç”Ÿæ”¯æŒæµå¼è¾“å‡ºå’Œå¢é‡å¤„ç†

### 5.2 è®¾è®¡ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æ¨¡å—åŒ–** | å„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæµ‹è¯• |
| **å¯æ‰©å±•** | æ–°å¢ Provider æˆ–å·¥å…·åªéœ€å®ç°æ¥å£ |
| **å®¹é”™æ€§** | è‡ªåŠ¨é‡è¯•ã€é”™è¯¯åˆ†ç±»ã€ä»»åŠ¡ä¸­æ­¢ |
| **æŒä¹…åŒ–** | ä¼šè¯æ¢å¤ã€ä¸Šä¸‹æ–‡å‹ç¼©ã€æ•°æ®å¤‡ä»½ |
| **ç”Ÿäº§å°±ç»ª** | å®Œå–„çš„é”™è¯¯å¤„ç†ã€è¶…æ—¶æ§åˆ¶ã€èµ„æºç®¡ç† |

### 5.3 æŠ€æœ¯äº®ç‚¹

1. **ä¸Šä¸‹æ–‡å‹ç¼©**: æ™ºèƒ½å‹ç¼©é•¿å¯¹è¯ï¼ŒèŠ‚çœ token
2. **å·¥å…·è°ƒç”¨ä¿®å¤**: è‡ªåŠ¨ä¿®å¤ä¸­æ–­çš„ tool call
3. **åŸå­å†™å…¥**: æŒä¹…åŒ–é‡‡ç”¨ä¸´æ—¶æ–‡ä»¶ + rename
4. **æµå¼å¤„ç†**: æ”¯æŒæ–‡æœ¬/æ¨ç†/å·¥å…·è°ƒç”¨çš„å¢é‡è¾“å‡º
5. **å¤š Provider**: æ”¯æŒ GLMã€Kimiã€MiniMax ç­‰å¤šç§ LLM

### 5.4 é€‚ç”¨åœºæ™¯

- æ™ºèƒ½ç¼–ç¨‹åŠ©æ‰‹
- ä»£ç å®¡æŸ¥å·¥å…·
- è‡ªåŠ¨åŒ–å¼€å‘æµç¨‹
- AI é©±åŠ¨çš„ä»»åŠ¡æ‰§è¡Œ
- å¤šè½®å¯¹è¯åº”ç”¨

---

## ç»“è®º

è¿™æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯ã€ç”Ÿäº§å°±ç»ªçš„ AI Agent æ¡†æ¶ï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„æ¶æ„è®¾è®¡å’Œæœ€ä½³å®è·µï¼Œé€‚åˆæ„å»ºå¤æ‚çš„ AI ç¼–ç åŠ©æ‰‹åº”ç”¨ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:
- æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†å’ŒèŒè´£åˆ†ç¦»
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- çµæ´»çš„æ‰©å±•èƒ½åŠ›ï¼ˆProvider/å·¥å…·ï¼‰
- ç”Ÿäº§çº§çš„æŒä¹…åŒ–å’Œå®¹é”™è®¾è®¡

---

*æœ¬æŠ¥å‘Šç”± Claude Code è‡ªåŠ¨ç”Ÿæˆ*
