# å­˜å‚¨æ¨¡å—æ·±åº¦åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¥æœŸ**: 2026-02-28  
**åˆ†ææ–¹å¼**: å¤šæ™ºèƒ½ä½“åä½œåˆ†æ (3 ä¸ªä¸“é¡¹æ™ºèƒ½ä½“)  
**åˆ†æèŒƒå›´**: `src/agent-v2/memory/` å®Œæ•´å­˜å‚¨æ¨¡å—

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡åˆ†æå¯¹é¡¹ç›®çš„å­˜å‚¨æ¨¡å—è¿›è¡Œäº†å…¨é¢æ·±åº¦è¯„ä¼°ï¼Œæ¶µç›–ä»£ç ç»“æ„ã€æ ¸å¿ƒå®ç°ã€æ¶æ„è®¾è®¡ã€æ€§èƒ½ç‰¹å¾ã€å®‰å…¨æ€§å’Œä»£ç è´¨é‡å…­ä¸ªç»´åº¦ã€‚

### æ€»ä½“è¯„åˆ†

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | ç­‰çº§ |
|---------|------|------|
| æ¶æ„è®¾è®¡ | 4.3/5 | ä¼˜ç§€ |
| æ ¸å¿ƒå®ç° | 4.0/5 | è‰¯å¥½ |
| æ€§èƒ½ç‰¹å¾ | 3.5/5 | ä¸­ç­‰ |
| å¯æ‰©å±•æ€§ | 3.7/5 | è‰¯å¥½ |
| å®‰å…¨æ€§ | 2.7/5 | éœ€æ”¹è¿› |
| ä»£ç è´¨é‡ | 3.7/5 | è‰¯å¥½ |
| **ç»¼åˆè¯„åˆ†** | **3.65/5** | **è‰¯å¥½** |

### å…³é”®å‘ç°

**ä¼˜åŠ¿**:
- âœ… æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ˆç«¯å£ - é€‚é…å™¨ - ç¼–æ’ - é¢†åŸŸï¼‰
- âœ… é€‚é…å™¨æ¨¡å¼æ”¯æŒå¤šå­˜å‚¨åç«¯ï¼ˆFile/MongoDB/Hybridï¼‰
- âœ… åŸå­å†™å…¥æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… å†…å­˜ç¼“å­˜å±‚æå‡è¯»å–æ€§èƒ½
- âœ… æ•°æ®ä¿®å¤æœºåˆ¶å¢å¼ºé²æ£’æ€§

**é£é™©**:
- ğŸ”´ å¹¶å‘æ§åˆ¶ä¸å®Œå–„ï¼Œå­˜åœ¨ç«æ€æ¡ä»¶
- ğŸ”´ æ— è‡ªåŠ¨è¿‡æœŸ/TTL æœºåˆ¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
- ğŸ”´ ç¼ºå°‘æ•°æ®åŠ å¯†ï¼Œæ•æ„Ÿä¿¡æ¯æ˜æ–‡å­˜å‚¨
- ğŸŸ¡ å¯åŠ¨æ—¶å…¨é‡åŠ è½½ï¼Œå¤§æ•°æ®é›†æ€§èƒ½å·®
- ğŸŸ¡ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ï¼Œå…³é”®è·¯å¾„ç¼ºå°‘éªŒè¯

---

## ç›®å½•

1. [ä»£ç ç»“æ„åˆ†æ](#1-ä»£ç ç»“æ„åˆ†æ)
2. [æ ¸å¿ƒå®ç°åˆ†æ](#2-æ ¸å¿ƒå®ç°åˆ†æ)
3. [æ¶æ„è®¾è®¡è¯„ä¼°](#3-æ¶æ„è®¾è®¡è¯„ä¼°)
4. [æ€§èƒ½ç‰¹å¾è¯„ä¼°](#4-æ€§èƒ½ç‰¹å¾è¯„ä¼°)
5. [å¯æ‰©å±•æ€§è¯„ä¼°](#5-å¯æ‰©å±•æ€§è¯„ä¼°)
6. [å®‰å…¨æ€§è¯„ä¼°](#6-å®‰å…¨æ€§è¯„ä¼°)
7. [ä»£ç è´¨é‡è¯„ä¼°](#7-ä»£ç è´¨é‡è¯„ä¼°)
8. [é—®é¢˜æ¸…å•ä¸ä¿®å¤å»ºè®®](#8-é—®é¢˜æ¸…å•ä¸ä¿®å¤å»ºè®®)
9. [æ”¹è¿›è·¯çº¿å›¾](#9-æ”¹è¿›è·¯çº¿å›¾)

---

## 1. ä»£ç ç»“æ„åˆ†æ

### 1.1 ç›®å½•ç»„ç»‡

```
src/agent-v2/memory/
â”œâ”€â”€ index.ts                          # æ¨¡å—å…¥å£å’Œå·¥å‚å‡½æ•°
â”œâ”€â”€ types.ts                          # ç±»å‹å®šä¹‰å’Œæ¥å£
â”œâ”€â”€ memory-manager.ts                 # MemoryManager ä¸»ç±»
â”œâ”€â”€ file-memory.ts                    # æ–‡ä»¶å­˜å‚¨å®ç°
â”œâ”€â”€ ports/
â”‚   â””â”€â”€ stores.ts                     # å­˜å‚¨ç«¯å£æ¥å£å®šä¹‰
â”œâ”€â”€ adapters/                         # å­˜å‚¨é€‚é…å™¨å±‚
â”‚   â”œâ”€â”€ capabilities.ts               # é€‚é…å™¨èƒ½åŠ›æè¿°
â”‚   â”œâ”€â”€ factory.ts                    # é€‚é…å™¨å·¥å‚
â”‚   â”œâ”€â”€ builders.ts                   # æ„å»ºå™¨å·¥å…·
â”‚   â”œâ”€â”€ unsupported-store-bundle.ts   # æœªå®ç°åç«¯å ä½
â”‚   â”œâ”€â”€ file/                         # æ–‡ä»¶å­˜å‚¨é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ file-store-bundle.ts      # æ–‡ä»¶å­˜å‚¨åŒ…åˆ›å»ºå™¨
â”‚   â”‚   â”œâ”€â”€ atomic-json.ts            # åŸå­ JSON æ–‡ä»¶æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ filename-codec.ts         # æ–‡ä»¶åç¼–ç å·¥å…·
â”‚   â”‚   â””â”€â”€ repositories/             # æ–‡ä»¶å­˜å‚¨ä»“åº“å®ç°
â”‚   â”‚       â”œâ”€â”€ file-session-store.ts
â”‚   â”‚       â”œâ”€â”€ file-context-store.ts
â”‚   â”‚       â”œâ”€â”€ file-history-store.ts
â”‚   â”‚       â”œâ”€â”€ file-compaction-store.ts
â”‚   â”‚       â”œâ”€â”€ file-task-store.ts
â”‚   â”‚       â””â”€â”€ file-subtask-run-store.ts
â”‚   â”œâ”€â”€ mongodb/                      # MongoDB å­˜å‚¨é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ driver.ts                 # MongoDB é©±åŠ¨å°è£…
â”‚   â”‚   â”œâ”€â”€ mongo-store-bundle.ts     # MongoDB å­˜å‚¨åŒ…
â”‚   â”‚   â””â”€â”€ test-utils/fake-mongo-module.ts
â”‚   â””â”€â”€ hybrid/                       # æ··åˆå­˜å‚¨é€‚é…å™¨
â”‚       â””â”€â”€ hybrid-store-bundle.ts    # æ··åˆå­˜å‚¨åŒ…
â”œâ”€â”€ orchestrator/                     # ç¼–æ’å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ memory-orchestrator.ts        # æ ¸å¿ƒç¼–æ’å™¨
â”‚   â”œâ”€â”€ bootstrap.ts                  # åˆå§‹åŒ–å’Œæ•°æ®ä¿®å¤
â”‚   â”œâ”€â”€ state.ts                      # å†…å­˜ç¼“å­˜çŠ¶æ€
â”‚   â”œâ”€â”€ session-context-service.ts    # ä¼šè¯ä¸Šä¸‹æ–‡æœåŠ¡
â”‚   â”œâ”€â”€ task-service.ts               # ä»»åŠ¡æœåŠ¡
â”‚   â””â”€â”€ subtask-run-service.ts        # å­ä»»åŠ¡è¿è¡ŒæœåŠ¡
â””â”€â”€ domain/                           # é¢†åŸŸå±‚
    â””â”€â”€ helpers.ts                    # é¢†åŸŸè¾…åŠ©å‡½æ•°
```

### 1.2 æ ¸å¿ƒæ¥å£æ¸…å•

#### å­˜å‚¨ç«¯å£æ¥å£ (`ports/stores.ts`)

| æ¥å£å | èŒè´£ | å…³é”®æ–¹æ³• |
|-------|------|---------|
| `SessionStore` | ä¼šè¯æ•°æ®å­˜å‚¨ | `prepare()`, `loadAll()`, `save()` |
| `ContextStore` | ä¸Šä¸‹æ–‡æ•°æ®å­˜å‚¨ | `prepare()`, `loadAll()`, `save()` |
| `HistoryStore` | å†å²æ¶ˆæ¯å­˜å‚¨ | `prepare()`, `loadAll()`, `save()` |
| `CompactionStore` | å‹ç¼©è®°å½•å­˜å‚¨ | `prepare()`, `loadAll()`, `save()` |
| `TaskStore` | ä»»åŠ¡æ•°æ®å­˜å‚¨ | `prepare()`, `loadAll()`, `saveBySession()` |
| `SubTaskRunStore` | å­ä»»åŠ¡è¿è¡Œå­˜å‚¨ | `prepare()`, `loadAll()`, `save()`, `delete()` |
| `MemoryStoreBundle` | å­˜å‚¨åŒ…èšåˆæ¥å£ | åŒ…å«æ‰€æœ‰ Store å®ä¾‹ + `close()` |

#### æ ¸å¿ƒä¸šåŠ¡æ¥å£ (`types.ts`)

| æ¥å£å | èŒè´£ |
|-------|------|
| `IMemoryManager` | MemoryManager ä¸»æ¥å£ï¼Œå®šä¹‰ 23 ä¸ªå­˜å‚¨æ“ä½œæ–¹æ³• |
| `StorageItem` | å­˜å‚¨é¡¹åŸºç¡€æ¥å£ |
| `HistoryMessage` | å†å²æ¶ˆæ¯ï¼ˆå«å…ƒæ•°æ®ï¼‰ |
| `CompactionRecord` | å‹ç¼©è®°å½• |
| `CurrentContext` | å½“å‰ä¸Šä¸‹æ–‡ï¼ˆç”¨äº LLM å¯¹è¯ï¼‰ |
| `SessionData` | ä¼šè¯æ•°æ®èšåˆ |
| `TaskData` | ä»»åŠ¡æ•°æ® |
| `SubTaskRunData` | å­ä»»åŠ¡è¿è¡Œæ•°æ® |
| `MemoryManagerOptions` | MemoryManager é…ç½®é€‰é¡¹ |

### 1.3 ç±»å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        IMemoryManager (æ¥å£)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ implements
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MemoryOrchestrator                          â”‚
â”‚  - å®ç° IMemoryManager æ¥å£                                      â”‚
â”‚  - ç®¡ç†å†…å­˜ç¼“å­˜ (MemoryCache)                                    â”‚
â”‚  - åè°ƒ SessionContextService/TaskService/SubTaskRunService      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ extends
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MemoryManager                             â”‚
â”‚  - é€šè¿‡å·¥å‚å‡½æ•°åˆ›å»ºå­˜å‚¨æŸ                                        â”‚
â”‚  - æ”¯æŒ file/mongodb/hybrid ç­‰åç«¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ extends
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FileMemoryManager                            â”‚
â”‚  - æ–‡ä»¶å­˜å‚¨ä¸“ç”¨å®ç°                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¤–éƒ¨è°ƒç”¨æ–¹ (Agent/Session/Tool)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ¨¡å—å…¥å£ (index.ts)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  createMemoryManager(options) å·¥å‚å‡½æ•°                               â”‚    â”‚
â”‚  â”‚  - æ”¯æŒï¼šfile / mysql / redis / mongodb / hybrid                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                 â–¼                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ FileMemoryManager â”‚ â”‚  MemoryManager    â”‚ â”‚  (å…¶ä»–ç±»å‹)       â”‚
        â”‚ (æ–‡ä»¶å­˜å‚¨ä¸“ç”¨)     â”‚ â”‚ (é€šç”¨ï¼Œå¯æ‰©å±•)     â”‚ â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      MemoryOrchestrator (ç¼–æ’å±‚)                     â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  â”‚  - å®ç° IMemoryManager æ¥å£                                  â”‚    â”‚
        â”‚  â”‚  - ç®¡ç†å†…å­˜ç¼“å­˜ (MemoryCache)                                â”‚    â”‚
        â”‚  â”‚  - å§”æ‰˜ä¸šåŠ¡é€»è¾‘åˆ° Services                                   â”‚    â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
        â”‚         â”‚              â”‚              â”‚                              â”‚
        â”‚         â–¼              â–¼              â–¼                              â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
        â”‚  â”‚SessionCtx   â”‚ â”‚  Task       â”‚ â”‚ SubTaskRun  â”‚                    â”‚
        â”‚  â”‚Service      â”‚ â”‚  Service    â”‚ â”‚ Service     â”‚                    â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      MemoryStoreBundle (å­˜å‚¨åŒ…)                      â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚sessions â”‚ â”‚contexts â”‚ â”‚historiesâ”‚ â”‚compactionsâ”‚ â”‚tasks â”‚ â”‚sub  â”‚  â”‚
        â”‚  â”‚Store    â”‚ â”‚Store    â”‚ â”‚Store    â”‚ â”‚Store    â”‚ â”‚Store â”‚ â”‚Task  â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚Run   â”‚  â”‚
        â”‚                                                          â”‚Store â”‚  â”‚
        â”‚                                                          â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  File Store     â”‚ â”‚  MongoDB Store  â”‚ â”‚  Hybrid Store   â”‚
    â”‚  Bundle         â”‚ â”‚  Bundle         â”‚ â”‚  Bundle         â”‚
    â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
    â”‚  - FileSession  â”‚ â”‚  - MongoSession â”‚ â”‚  ç»„åˆå¤šä¸ªåç«¯    â”‚
    â”‚  - FileContext  â”‚ â”‚  - MongoContext â”‚ â”‚  (short/mid/    â”‚
    â”‚  - FileHistory  â”‚ â”‚  - MongoHistory â”‚ â”‚   long-term)    â”‚
    â”‚  - FileCompactionâ”‚ â”‚ - MongoCompactionâ”‚ â”‚                 â”‚
    â”‚  - FileTask     â”‚ â”‚  - MongoTask    â”‚ â”‚                 â”‚
    â”‚  - FileSubTaskRunâ”‚ â”‚ - MongoSubTaskRunâ”‚ â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                 â”‚
              â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  AtomicJsonStoreâ”‚ â”‚  MongoConnectionâ”‚
    â”‚  (åŸå­æ–‡ä»¶æ“ä½œ)  â”‚ â”‚  (é©±åŠ¨å°è£…)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒå®ç°åˆ†æ

### 2.1 MemoryManager ç±»

**æ–‡ä»¶ä½ç½®**: `memory-manager.ts` (ç¬¬ 1-13 è¡Œ)

```typescript
export class MemoryManager extends MemoryOrchestrator {
    constructor(options: MemoryManagerOptions) {
        super(createStoreBundle(options));
    }
}
```

**åˆ†æ**:
- **èŒè´£**: å¯é…ç½®çš„å†…å­˜ç®¡ç†å™¨ï¼Œæ˜¯ `MemoryOrchestrator` çš„ç®€å•åŒ…è£…
- **å®ç°å¤æ‚åº¦**: â­ (æä½) - ä»… 3 è¡Œæ ¸å¿ƒä»£ç 
- **è®¾è®¡æ¨¡å¼**: ç»„åˆæ¨¡å¼ï¼Œé€šè¿‡å·¥å‚å‡½æ•°åˆ›å»ºå­˜å‚¨æŸ

### 2.2 MemoryOrchestrator ç±»

**æ–‡ä»¶ä½ç½®**: `memory-orchestrator.ts` (ç¬¬ 17-147 è¡Œ)

**æ ¸å¿ƒèŒè´£**: å†…å­˜æ“ä½œçš„ç¼–æ’å™¨ï¼Œåè°ƒå„ä¸ªæœåŠ¡ç±»

**å…³é”®å±æ€§**:
| å±æ€§ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `initialized` | `boolean` | åˆå§‹åŒ–çŠ¶æ€æ ‡å¿— |
| `initializePromise` | `Promise<void> \| null` | é˜²æ­¢å¹¶å‘åˆå§‹åŒ–çš„é” |
| `cache` | `MemoryCache` | å†…å­˜ç¼“å­˜å±‚ |
| `sessionContext` | `SessionContextService` | ä¼šè¯ä¸Šä¸‹æ–‡æœåŠ¡ |
| `taskService` | `TaskService` | ä»»åŠ¡æœåŠ¡ |
| `subTaskRunService` | `SubTaskRunService` | å­ä»»åŠ¡è¿è¡ŒæœåŠ¡ |

**åˆå§‹åŒ–æµç¨‹** (ç¬¬ 35-51 è¡Œ):
```typescript
async initialize(): Promise<void> {
    if (this.initialized) return;                    // å·²åˆå§‹åŒ–ç›´æ¥è¿”å›
    if (this.initializePromise) {                    // é˜²æ­¢å¹¶å‘åˆå§‹åŒ–
        return this.initializePromise;
    }
    this.initializePromise = this.doInitialize();    // åˆ›å»º Promise
    try {
        await this.initializePromise;
    } finally {
        this.initializePromise = null;
    }
}
```

**å¹¶å‘æ§åˆ¶åˆ†æ**:
- âœ… ä½¿ç”¨ `initializePromise` é˜²æ­¢å¹¶å‘åˆå§‹åŒ–
- âš ï¸ **é—®é¢˜**: `ensureInitialized()` æ–¹æ³• (ç¬¬ 133-139 è¡Œ) æ²¡æœ‰å¼‚æ­¥ç­‰å¾…æœºåˆ¶ï¼Œå¦‚æœç”¨æˆ·åœ¨ `initialize()` å®Œæˆå‰è°ƒç”¨å…¶ä»–æ–¹æ³•ä¼šæŠ›å‡ºé”™è¯¯

### 2.3 SessionContextService ç±»

**æ–‡ä»¶ä½ç½®**: `session-context-service.ts` (ç¬¬ 22-332 è¡Œ)

**æ ¸å¿ƒèŒè´£**: ç®¡ç†ä¼šè¯ã€ä¸Šä¸‹æ–‡ã€å†å²å’Œå‹ç¼©è®°å½•

**å…³é”®æ–¹æ³•åˆ†æ**:

#### 3.1 `createSession` (ç¬¬ 28-88 è¡Œ)
```typescript
async createSession(sessionId: string | undefined, systemPrompt: string): Promise<string>
```
- **å¤æ‚åº¦**: â­â­â­ (ä¸­ç­‰)
- **æ“ä½œ**: åˆ›å»º session/context/history/compaction å››ç»„æ•°æ®
- **å¹¶å‘æ§åˆ¶**: âŒ æ— é”ä¿æŠ¤ï¼Œå­˜åœ¨ç«æ€æ¡ä»¶
- **é—®é¢˜**: ç¬¬ 30-32 è¡Œæ£€æŸ¥ `cache.sessions.has(sid)` åç›´æ¥åˆ›å»ºï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½é‡å¤åˆ›å»º

#### 3.2 `addMessageToContext` (ç¬¬ 128-168 è¡Œ)
```typescript
async addMessageToContext(sessionId: string, message: Message, options?: { addToHistory?: boolean })
```
- **å¤æ‚åº¦**: â­â­â­ (ä¸­ç­‰)
- **æ•°æ®æµ**: åŒæ—¶æ›´æ–° context.messages å’Œ history
- **åŸå­æ€§**: âš ï¸ ä½¿ç”¨ `Promise.all` å¹¶è¡Œå†™å…¥ï¼Œä½†æ— äº‹åŠ¡ä¿è¯

#### 3.3 `compactContext` (ç¬¬ 237-305 è¡Œ)
```typescript
async compactContext(sessionId: string, options: CompactContextOptions): Promise<CompactionRecord>
```
- **å¤æ‚åº¦**: â­â­â­â­ (é«˜)
- **æ“ä½œ**: 
  1. å½’æ¡£æ—§æ¶ˆæ¯åˆ°å†å²è®°å½•
  2. åˆ›å»ºæ‘˜è¦æ¶ˆæ¯
  3. æ›´æ–°ä¸Šä¸‹æ–‡
  4. åˆ›å»ºå‹ç¼©è®°å½•
- **é—®é¢˜**: ç¬¬ 263-266 è¡Œæ ‡è®°å½’æ¡£æ¶ˆæ¯æ—¶æ— é”ä¿æŠ¤

### 2.4 AtomicJsonStore ç±»

**æ–‡ä»¶ä½ç½®**: `adapters/file/atomic-json.ts` (ç¬¬ 5-186 è¡Œ)

**æ ¸å¿ƒèŒè´£**: æä¾›åŸå­æ€§çš„ JSON æ–‡ä»¶è¯»å†™æ“ä½œ

**å…³é”®æœºåˆ¶**:

#### æ–‡ä»¶æ“ä½œé˜Ÿåˆ— (ç¬¬ 169-182 è¡Œ)
```typescript
private enqueueFileOperation(filePath: string, operation: () => Promise<void>): Promise<void> {
    const previous = this.fileOperationQueue.get(filePath) || Promise.resolve();
    const pending = previous.catch(() => {}).then(operation);
    // ... è·Ÿè¸ªå’Œç®¡ç† pending æ“ä½œ
}
```
- **å¹¶å‘æ§åˆ¶**: âœ… æ¯æ–‡ä»¶ä¸²è¡ŒåŒ–å†™å…¥æ“ä½œ
- **å®ç°**: ä½¿ç”¨ Promise é“¾ç¡®ä¿åŒæ–‡ä»¶æ“ä½œé¡ºåºæ‰§è¡Œ

#### åŸå­å†™å…¥æµç¨‹ (ç¬¬ 49-66 è¡Œ)
```typescript
async writeJsonFile(filePath: string, value: unknown): Promise<void> {
    await this.enqueueFileOperation(filePath, async () => {
        await fs.mkdir(path.dirname(filePath), { recursive: true });
        await this.copyFileIfExists(filePath, this.getBackupFilePath(filePath)); // å¤‡ä»½
        
        const tempFilePath = this.buildTempFilePath(filePath);
        try {
            await fs.writeFile(tempFilePath, json, 'utf-8');  // å†™ä¸´æ—¶æ–‡ä»¶
            await this.renameWithRetry(tempFilePath, filePath); // åŸå­é‡å‘½å
        } finally {
            await this.unlinkIfExists(tempFilePath);
        }
    });
}
```

#### é”™è¯¯æ¢å¤æœºåˆ¶ (ç¬¬ 28-47 è¡Œ)
- ä¸»æ–‡ä»¶æŸåæ—¶å°è¯•ä» `.bak` å¤‡ä»½æ¢å¤
- æ¢å¤æˆåŠŸåè‡ªåŠ¨å½’æ¡£æŸåæ–‡ä»¶ä¸º `.corrupt-{timestamp}`

#### é‡å‘½åé‡è¯• (ç¬¬ 78-95 è¡Œ)
```typescript
private async renameWithRetry(src: string, dest: string, maxRetries = 5, delayMs = 100)
```
- é’ˆå¯¹ Windows EPERM é”™è¯¯çš„é‡è¯•æœºåˆ¶
- æŒ‡æ•°é€€é¿ç­–ç•¥

### 2.5 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MemoryManager / MemoryOrchestrator                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚SessionContextSvcâ”‚  â”‚    TaskService      â”‚  â”‚  SubTaskRunService    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚                         â”‚
            â–¼                      â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              MemoryCache (Map-based)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚sessions  â”‚ â”‚contexts  â”‚ â”‚histories  â”‚ â”‚compactions  â”‚ â”‚tasks  â”‚ â”‚runs â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚                         â”‚
            â–¼                      â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MemoryStoreBundle                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Session   â”‚ â”‚Context   â”‚ â”‚History    â”‚ â”‚Compaction   â”‚ â”‚Task   â”‚ â”‚Run  â”‚ â”‚
â”‚  â”‚Store     â”‚ â”‚Store     â”‚ â”‚Store      â”‚ â”‚Store        â”‚ â”‚Store  â”‚ â”‚Storeâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
        â”‚            â”‚             â”‚              â”‚            â”‚        â”‚
        â–¼            â–¼             â–¼              â–¼            â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Storage Adapter Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    File Adapter         â”‚           â”‚      MongoDB Adapter             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  AtomicJsonStore â”‚   â”‚           â”‚  â”‚   MongoConnection        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - æ–‡ä»¶æ“ä½œé˜Ÿåˆ—   â”‚   â”‚           â”‚  â”‚   - è¿æ¥ç®¡ç†             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - å¤‡ä»½æ¢å¤       â”‚   â”‚           â”‚  â”‚   - é›†åˆæ“ä½œ             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - åŸå­é‡å‘½å     â”‚   â”‚           â”‚  â”‚   - replaceOne upsert    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                      â”‚
            â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     File System         â”‚           â”‚          MongoDB Server             â”‚
â”‚  .memory/               â”‚           â”‚  memory_sessions                    â”‚
â”‚  â”œâ”€â”€ sessions/          â”‚           â”‚  memory_contexts                    â”‚
â”‚  â”œâ”€â”€ contexts/          â”‚           â”‚  memory_histories                   â”‚
â”‚  â”œâ”€â”€ histories/         â”‚           â”‚  memory_compactions                 â”‚
â”‚  â”œâ”€â”€ tasks/             â”‚           â”‚  memory_tasks                       â”‚
â”‚  â””â”€â”€ subtask-runs/      â”‚           â”‚  memory_subtask_runs                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ¶æ„è®¾è®¡è¯„ä¼°

### 3.1 åˆ†å±‚æ¸…æ™°åº¦ â­â­â­â­ (4/5)

**æ¶æ„åˆ†å±‚**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Orchestrator)                 â”‚
â”‚  MemoryOrchestrator / SessionContextService / TaskService â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ç«¯å£å±‚ (Ports)                        â”‚
â”‚  SessionStore | ContextStore | HistoryStore | TaskStore  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   é€‚é…å™¨å±‚ (Adapters)                     â”‚
â”‚  FileStoreBundle | MongoStoreBundle | HybridStoreBundle  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   åŸºç¡€è®¾æ–½å±‚ (Infrastructure)             â”‚
â”‚  AtomicJsonStore | MongoConnection | Driver              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:
- `ports/stores.ts` å®šä¹‰äº†æ¸…æ™°çš„å­˜å‚¨æ¥å£ï¼ˆ6 ä¸ª Store æ¥å£ï¼‰
- `adapters/` ç›®å½•åŒ…å«å…·ä½“å®ç°ï¼ˆfile/mongodb/hybridï¼‰
- `orchestrator/` ç›®å½•åŒ…å«ä¸šåŠ¡é€»è¾‘ç¼–æ’

**æ”¹è¿›å»ºè®®**:
```typescript
// å½“å‰ï¼šMemoryOrchestrator ç›´æ¥ä¾èµ–å…·ä½“ Store æ¥å£
constructor(private readonly stores: MemoryStoreBundle)

// å»ºè®®ï¼šå¼•å…¥ Repository æ¨¡å¼è¿›ä¸€æ­¥æŠ½è±¡
interface IRepository<T, ID = string> {
    findById(id: ID): Promise<T | null>;
    save(entity: T): Promise<void>;
    delete(id: ID): Promise<void>;
}
```

### 3.2 èŒè´£åˆ†ç¦» (å•ä¸€èŒè´£åŸåˆ™) â­â­â­â­â­ (5/5)

| ç±» | èŒè´£ | ä»£ç è¡Œæ•° |
|---|---|---|
| `MemoryOrchestrator` | ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€åˆå§‹åŒ–åè°ƒ | ~150 è¡Œ |
| `SessionContextService` | ä¼šè¯å’Œä¸Šä¸‹æ–‡ä¸šåŠ¡é€»è¾‘ | ~300 è¡Œ |
| `TaskService` | ä»»åŠ¡ç®¡ç† | ~80 è¡Œ |
| `FileTaskStore` | æ–‡ä»¶å­˜å‚¨å®ç° | ~60 è¡Œ |
| `AtomicJsonStore` | åŸå­æ–‡ä»¶ I/O | ~180 è¡Œ |

```typescript
// ä¼˜ç§€çš„èŒè´£åˆ†ç¦»ç¤ºä¾‹
export class SessionContextService {
    constructor(
        private readonly cache: MemoryCache,  // ç¼“å­˜å±‚
        private readonly stores: MemoryStoreBundle  // å­˜å‚¨å±‚
    ) {}
    // åªå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¸å…³å¿ƒå­˜å‚¨å®ç°
}
```

### 3.3 ä¾èµ–æ³¨å…¥å’Œå¯æµ‹è¯•æ€§ â­â­â­â­ (4/5)

**ä¼˜ç‚¹**:
```typescript
// æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
constructor(
    private readonly cache: MemoryCache,
    private readonly stores: MemoryStoreBundle
)

// å·¥å‚æ¨¡å¼åˆ›å»ºå­˜å‚¨æŸ
export function createStoreBundle(options: MemoryManagerOptions): MemoryStoreBundle
```

**æµ‹è¯•è¦†ç›–**:
- `factory.test.ts` - 6 ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–æ‰€æœ‰å­˜å‚¨ç±»å‹
- `atomic-json.test.ts` - 3 ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–åŸå­å†™å…¥
- `fake-mongo-module.ts` - æä¾› MongoDB æ¨¡æ‹Ÿ

**æ”¹è¿›å»ºè®®**:
```typescript
// å½“å‰ï¼šæµ‹è¯•éœ€è¦çœŸå®æ–‡ä»¶ç³»ç»Ÿ
// å»ºè®®ï¼šæ·»åŠ  Store æ¥å£çš„ Mock å®ç°
interface MockableStore {
    // æ·»åŠ æµ‹è¯•é’©å­
    __setMockData?(data: Map<string, unknown>): void;
    __getCallHistory?(): CallRecord[];
}
```

### 3.4 å¼€é—­åŸåˆ™ â­â­â­â­ (4/5)

**ä¼˜ç‚¹**:
```typescript
// æ‰©å±•æ–°å­˜å‚¨åç«¯åªéœ€æ·»åŠ æ–°é€‚é…å™¨
case 'mongodb':
    return createMongoStoreBundle(options);
case 'hybrid':
    return createHybridStoreBundle(options);
```

**capabilities.ts å®šä¹‰äº†æ¸…æ™°çš„æ‰©å±•ç‚¹**:
```typescript
export type MemoryAdapterCapability =
    | 'atomic_write'
    | 'ttl'
    | 'secondary_index'
    | 'semantic_search'
    | 'tier_routing'
    | 'cross_store_transaction';
```

**æ”¹è¿›å»ºè®®**:
```typescript
// å½“å‰ï¼šfactory.ts éœ€è¦ä¿®æ”¹ switch è¯­å¥
// å»ºè®®ï¼šä½¿ç”¨æ³¨å†Œè¡¨æ¨¡å¼
interface StoreAdapter {
    type: string;
    create: (options: MemoryManagerOptions) => MemoryStoreBundle;
}

class AdapterRegistry {
    private adapters = new Map<string, StoreAdapter>();
    register(adapter: StoreAdapter): void;
    create(type: string, options: MemoryManagerOptions): MemoryStoreBundle;
}
```

---

## 4. æ€§èƒ½ç‰¹å¾è¯„ä¼°

### 4.1 ç¼“å­˜æœºåˆ¶ â­â­â­â­â­ (5/5)

**å…·ä½“å®ç°**:
```typescript
// orchestrator/state.ts
export interface MemoryCache {
    sessions: Map<string, SessionData>;
    contexts: Map<string, CurrentContext>;
    histories: Map<string, HistoryMessage[]>;
    compactionRecords: Map<string, CompactionRecord[]>;
    tasks: Map<string, TaskData>;
    subTaskRuns: Map<string, SubTaskRunData>;
}

// å¯åŠ¨æ—¶å…¨é‡åŠ è½½åˆ°å†…å­˜
export async function loadAndRepairCache(cache: MemoryCache, stores: MemoryStoreBundle)
```

**ä¼˜ç‚¹**:
- æ‰€æœ‰è¯»å–æ“ä½œå…ˆæŸ¥ç¼“å­˜ï¼Œé¿å…é‡å¤ I/O
- å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜å’ŒæŒä¹…åŒ–å­˜å‚¨
- å¯åŠ¨æ—¶æ•°æ®ä¿®å¤æœºåˆ¶ä¿è¯ä¸€è‡´æ€§

**æ”¹è¿›å»ºè®®**:
```typescript
// å½“å‰ï¼šå…¨é‡åŠ è½½ï¼Œå¤§æ•°æ®é‡å¯èƒ½å†…å­˜æº¢å‡º
// å»ºè®®ï¼šæ·»åŠ  LRU ç¼“å­˜å’Œæ‡’åŠ è½½
interface CacheConfig {
    maxSize?: number;        // æœ€å¤§æ¡ç›®æ•°
    ttlMs?: number;          // è¿‡æœŸæ—¶é—´
    lazyLoad?: boolean;      // æ‡’åŠ è½½
}
```

### 4.2 å¤§æ•°æ®é‡è¡¨ç° â­â­â­ (3/5)

**é—®é¢˜**:
```typescript
// bootstrap.ts - å¯åŠ¨æ—¶å…¨é‡åŠ è½½æ‰€æœ‰æ•°æ®
cache.sessions = await stores.sessions.loadAll();  // å¯èƒ½åŠ è½½å¤§é‡æ•°æ®
cache.contexts = await stores.contexts.loadAll();
cache.histories = await stores.histories.loadAll();
```

**AtomicJsonStore çš„æ–‡ä»¶æ“ä½œé˜Ÿåˆ—**:
```typescript
// ä¼˜ç‚¹ï¼šé˜²æ­¢å¹¶å‘å†™å…¥å†²çª
private readonly fileOperationQueue = new Map<string, Promise<void>>();

// ç¼ºç‚¹ï¼šåŒä¸€æ–‡ä»¶çš„é«˜é¢‘å†™å…¥ä¼šä¸²è¡ŒåŒ–
private enqueueFileOperation(filePath: string, operation: () => Promise<void>)
```

**æ”¹è¿›å»ºè®®**:
```typescript
// 1. åˆ†é¡µåŠ è½½
async loadAll(options?: { limit?: number; offset?: number }): Promise<Map<string, T>>;

// 2. æ·»åŠ ç´¢å¼•æ”¯æŒ
interface IndexConfig {
    field: string;
    type: 'btree' | 'hash';
}

// 3. æ‰¹é‡å†™å…¥ä¼˜åŒ–
async saveBatch(items: Array<{ id: string; data: T }>): Promise<void>;
```

### 4.3 I/O æ“ä½œä¼˜åŒ– â­â­â­â­ (4/5)

**AtomicJsonStore çš„ä¼˜åŒ–æªæ–½**:
```typescript
// 1. åŸå­å†™å…¥ï¼šä¸´æ—¶æ–‡ä»¶ + rename
const tempFilePath = this.buildTempFilePath(filePath);
await fs.writeFile(tempFilePath, json, 'utf-8');
await this.renameWithRetry(tempFilePath, filePath);

// 2. å¤‡ä»½æ¢å¤æœºåˆ¶
await this.copyFileIfExists(filePath, this.getBackupFilePath(filePath));

// 3. å†™å…¥é˜Ÿåˆ—é˜²æ­¢å†²çª
private enqueueFileOperation(filePath: string, operation: () => Promise<void>)

// 4. rename é‡è¯•æœºåˆ¶ï¼ˆå¤„ç† Windows EPERMï¼‰
private async renameWithRetry(src: string, dest: string, maxRetries = 5)
```

**æ”¹è¿›å»ºè®®**:
```typescript
// æ·»åŠ å†™å…¥æ‰¹å¤„ç†
private writeBatchBuffer = new Map<string, { data: unknown; resolve: () => void }>();
private flushInterval = 100; // ms

// æ·»åŠ å‹ç¼©å­˜å‚¨é€‰é¡¹
interface StorageOptions {
    compression?: 'gzip' | 'none';
}
```

### 4.4 å†…å­˜ç®¡ç† â­â­â­ (3/5)

**å½“å‰é—®é¢˜**:
```typescript
// æ‰€æœ‰æ•°æ®å¸¸é©»å†…å­˜ï¼Œæ— æ·˜æ±°æœºåˆ¶
export function createMemoryCache(): MemoryCache {
    return {
        sessions: new Map(),
        contexts: new Map(),
        histories: new Map(),  // å†å²æ¶ˆæ¯å¯èƒ½éå¸¸å¤§
        // ...
    };
}
```

**æ”¹è¿›å»ºè®®**:
```typescript
// 1. ä½¿ç”¨ LRU ç¼“å­˜
import { LRUCache } from 'lru-cache';

class MemoryCache {
    private contexts: LRUCache<string, CurrentContext>;
    private histories: LRUCache<string, HistoryMessage[]>;
    
    constructor(config: { maxContexts: number; maxHistorySize: number }) {
        this.contexts = new LRUCache({ max: config.maxContexts });
        this.histories = new LRUCache({ 
            max: config.maxHistorySize,
            sizeCalculation: (messages) => messages.length 
        });
    }
}

// 2. æ·»åŠ å†…å­˜ç›‘æ§
interface MemoryStats {
    usedHeapMB: number;
    cacheHitRate: number;
    evictedCount: number;
}
```

---

## 5. å¯æ‰©å±•æ€§è¯„ä¼°

### 5.1 æ·»åŠ æ–°å­˜å‚¨åç«¯éš¾åº¦ â­â­â­â­ (4/5)

**å½“å‰æµç¨‹**:
1. åœ¨ `ports/stores.ts` ç¡®è®¤æ¥å£ï¼ˆé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰
2. åˆ›å»ºæ–°é€‚é…å™¨ç›®å½• `src/agent-v2/memory/adapters/<backend>/`
3. å®ç° 6 ä¸ª Store æ¥å£
4. åœ¨ `factory.ts` æ·»åŠ  case åˆ†æ”¯
5. åœ¨ `capabilities.ts` æ³¨å†Œèƒ½åŠ›æè¿°

**ç¤ºä¾‹ï¼ˆæ·»åŠ  Redis åç«¯ï¼‰**:
```typescript
// adapters/redis/redis-store-bundle.ts
class RedisSessionStore implements SessionStore {
    constructor(private readonly client: RedisClient) {}
    async prepare(): Promise<void> { /* ... */ }
    async loadAll(): Promise<Map<string, SessionData>> { /* ... */ }
    async save(sessionId: string, session: SessionData): Promise<void> { /* ... */ }
}

// factory.ts
case 'redis':
    return createRedisStoreBundle(options);

// capabilities.ts
redis: {
    type: 'redis',
    status: 'ready',
    capabilities: ['ttl', 'atomic_write'],
}
```

**æ”¹è¿›å»ºè®®**:
```typescript
// æä¾›åŸºç¡€å®ç°ç±»å‡å°‘é‡å¤ä»£ç 
abstract class BaseStore<T> implements Store<T> {
    abstract loadAll(): Promise<Map<string, T>>;
    abstract save(id: string, data: T): Promise<void>;
    
    // æä¾›é€šç”¨å®ç°
    async prepare(): Promise<void> {}
    async delete(id: string): Promise<void> {
        throw new Error('Not implemented');
    }
}
```

### 5.2 æ’ä»¶åŒ–æ‰©å±• â­â­â­ (3/5)

**å½“å‰é™åˆ¶**:
```typescript
// factory.ts - ç¡¬ç¼–ç çš„ switch è¯­å¥
switch (options.type) {
    case 'file': return createBundleFromDescriptor(...);
    case 'mongodb': return createMongoStoreBundle(options);
    // éœ€è¦ä¿®æ”¹æºç æ·»åŠ æ–°ç±»å‹
}
```

**æ”¹è¿›å»ºè®®**:
```typescript
// 1. åŠ¨æ€æ’ä»¶åŠ è½½
interface MemoryPlugin {
    name: string;
    version: string;
    create: (options: Record<string, unknown>) => MemoryStoreBundle;
    capabilities: MemoryAdapterCapability[];
}

class PluginManager {
    async loadPlugin(path: string): Promise<MemoryPlugin>;
    register(plugin: MemoryPlugin): void;
}

// 2. é…ç½®æ–‡ä»¶é©±åŠ¨
// memory.config.json
{
    "plugins": [
        { "name": "@agent/memory-redis", "options": { "host": "localhost" } },
        { "name": "@agent/memory-s3", "options": { "bucket": "..." } }
    ]
}
```

### 5.3 é…ç½®ç®¡ç†çµæ´»æ€§ â­â­â­â­ (4/5)

**å½“å‰é…ç½®ç»“æ„**:
```typescript
export interface MemoryManagerOptions {
    type: SupportedMemoryManagerType | string;
    connectionString?: string;
    config?: Record<string, unknown> & {
        hybrid?: HybridMemoryConfig;
    };
}

export interface HybridMemoryConfig {
    shortTerm?: MemoryBackendDescriptor;
    midTerm?: MemoryBackendDescriptor;
    longTerm?: MemoryBackendDescriptor;
}
```

**MongoDB é…ç½®ç¤ºä¾‹**:
```typescript
// æ”¯æŒå¤šç§é…ç½®æ¥æº
const config = {
    connectionString: 'mongodb://...',           // ç›´æ¥é…ç½®
    connectionEnvKey: 'MONGODB_URI',             // ç¯å¢ƒå˜é‡é”®å
    dbName: 'agent_memory',                      // æ•°æ®åº“å
    collectionPrefix: 'memory_',                 // é›†åˆå‰ç¼€
    moduleName: 'mongodb',                       // é©±åŠ¨æ¨¡å—å
    moduleLoader: () => import('mongodb'),       // è‡ªå®šä¹‰åŠ è½½å™¨
};
```

---

## 6. å®‰å…¨æ€§è¯„ä¼°

### 6.1 æ•æ„Ÿæ•°æ®ä¿æŠ¤ â­â­â­ (3/5)

**å½“å‰é—®é¢˜**:
```typescript
// æ‰€æœ‰æ•°æ®ä»¥æ˜æ–‡ JSON å­˜å‚¨
await fs.writeFile(tempFilePath, json, 'utf-8');  // æ— åŠ å¯†

// SessionData å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯
interface SessionData {
    systemPrompt: string;      // å¯èƒ½åŒ…å« API å¯†é’¥
    metadata?: Record<string, unknown>;  // æœªåŠ å¯†
}
```

**æ”¹è¿›å»ºè®®**:
```typescript
// 1. æ·»åŠ åŠ å¯†å±‚
interface EncryptionService {
    encrypt(data: string): Promise<string>;
    decrypt(cipher: string): Promise<string>;
}

class EncryptedJsonStore extends AtomicJsonStore {
    constructor(private readonly encryption: EncryptionService) {
        super();
    }
    
    async writeJsonFile(filePath: string, value: unknown): Promise<void> {
        const json = JSON.stringify(value);
        const encrypted = await this.encryption.encrypt(json);
        // ... å†™å…¥åŠ å¯†å†…å®¹
    }
}

// 2. æ•æ„Ÿå­—æ®µæ ‡è®°
interface SessionData {
    systemPrompt: string;
    @Sensitive()
    metadata?: Record<string, unknown>;
}
```

### 6.2 æ–‡ä»¶æ“ä½œæƒé™æ§åˆ¶ â­â­â­ (3/5)

**å½“å‰å®ç°**:
```typescript
// ä½¿ç”¨é»˜è®¤æƒé™åˆ›å»ºç›®å½•
await fs.mkdir(dirPath, { recursive: true });  // æ— æƒé™æ§åˆ¶

// æ— æ–‡ä»¶è®¿é—®æƒé™éªŒè¯
async readJsonFile<T>(filePath: string): Promise<T | null> {
    return await fs.readFile(filePath, 'utf-8');  // ä»»ä½•å¯è¯»æ–‡ä»¶éƒ½èƒ½è¯»å–
}
```

**æ”¹è¿›å»ºè®®**:
```typescript
// 1. è®¾ç½®å®‰å…¨çš„ç›®å½•æƒé™
await fs.mkdir(dirPath, { 
    recursive: true, 
    mode: 0o700  // ä»…æ‰€æœ‰è€…å¯è®¿é—®
});

// 2. è·¯å¾„éå†é˜²æŠ¤
function sanitizePath(basePath: string, userPath: string): string {
    const resolved = path.resolve(basePath, userPath);
    if (!resolved.startsWith(basePath)) {
        throw new Error('Invalid path');
    }
    return resolved;
}

// 3. æ–‡ä»¶æ‰€æœ‰æƒéªŒè¯
interface FileAccessControl {
    canRead(sessionId: string, filePath: string): Promise<boolean>;
    canWrite(sessionId: string, filePath: string): Promise<boolean>;
}
```

### 6.3 æ•°æ®åŠ å¯†éœ€æ±‚ â­â­ (2/5)

**å½“å‰çŠ¶æ€**:
- âŒ æ— é™æ€æ•°æ®åŠ å¯†
- âŒ æ— ä¼ è¾“åŠ å¯†ï¼ˆMongoDB è¿æ¥å¯èƒ½æœªå¯ç”¨ TLSï¼‰
- âŒ æ— å¯†é’¥ç®¡ç†

**æ”¹è¿›å»ºè®®**:
```typescript
// 1. é™æ€æ•°æ®åŠ å¯†
interface EncryptionConfig {
    algorithm: 'aes-256-gcm';
    keySource: 'env' | 'vault' | 'aws-kms';
    keyEnvVar?: string;
}

// 2. MongoDB TLS é…ç½®
const mongoConfig = {
    connectionString: 'mongodb://...',
    clientOptions: {
        tls: true,
        tlsCAFile: '/path/to/ca.pem',
        tlsCertificateKeyFile: '/path/to/cert.pem',
    }
};

// 3. å¯†é’¥è½®æ¢æ”¯æŒ
interface KeyRotation {
    rotateKey(): Promise<void>;
    getCurrentKeyId(): string;
}
```

---

## 7. ä»£ç è´¨é‡è¯„ä¼°

### 7.1 ä»£ç é‡å¤åº¦ â­â­â­â­ (4/5)

**é‡å¤æ¨¡å¼åˆ†æ**:

6 ä¸ª Store å®ç°æœ‰ç›¸ä¼¼ç»“æ„ï¼š
```typescript
// FileSessionStore, FileContextStore, FileHistoryStore ç­‰
class FileXxxStore implements XxxStore {
    private readonly dirPath: string;
    
    constructor(
        basePath: string,
        private readonly io: AtomicJsonStore
    ) {
        this.dirPath = path.join(basePath, 'xxx');
    }
    
    async prepare(): Promise<void> {
        await this.io.ensureDir(this.dirPath);
    }
    
    async loadAll(): Promise<Map<string, T>> { /* ç›¸ä¼¼é€»è¾‘ */ }
    async save(): Promise<void> { /* ç›¸ä¼¼é€»è¾‘ */ }
}
```

**MongoDB å®ç°ä¹Ÿæœ‰ç±»ä¼¼é‡å¤**:
```typescript
class MongoXxxStore implements XxxStore {
    private readonly delegate: MongoEntityStore<T>;
    // å¤§é‡é‡å¤çš„å§”æ‰˜ä»£ç 
}
```

**æ”¹è¿›å»ºè®®**:
```typescript
// æ³›å‹åŸºç¡€å®ç°
abstract class BaseFileStore<T> {
    protected readonly dirPath: string;
    
    constructor(
        basePath: string,
        protected readonly io: AtomicJsonStore,
        collectionName: string
    ) {
        this.dirPath = path.join(basePath, collectionName);
    }
    
    async prepare(): Promise<void> {
        await this.io.ensureDir(this.dirPath);
    }
    
    protected abstract getId(item: T): string;
    protected abstract getFileName(id: string): string;
    
    async loadAll(): Promise<Map<string, T>> {
        // é€šç”¨å®ç°
    }
}
```

### 7.2 æ³¨é‡Šå’Œæ–‡æ¡£å®Œæ•´æ€§ â­â­â­â­ (4/5)

**ä¼˜ç‚¹**:
```typescript
/**
 * MemoryManager ç±»å‹å®šä¹‰
 *
 * æ ¸å¿ƒæ¦‚å¿µï¼š
 * 1. å½“å‰ä¸Šä¸‹æ–‡ (Current Context) - ç”¨äº LLM å¯¹è¯çš„æ´»è·ƒæ¶ˆæ¯ï¼Œå¯èƒ½è¢«å‹ç¼©
 * 2. å®Œæ•´å†å² (Full History) - æ‰€æœ‰åŸå§‹æ¶ˆæ¯ï¼ŒåŒ…å«è¢«å‹ç¼©æ›¿æ¢çš„æ¶ˆæ¯
 * 3. å‹ç¼©è®°å½• (Compaction Records) - è®°å½•ä½•æ—¶å‘ç”Ÿäº†å‹ç¼©ä»¥åŠå½±å“èŒƒå›´
 */

/**
 * ä»å½“å‰ä¸Šä¸‹æ–‡ä¸­åˆ é™¤æŒ‡å®šæ¶ˆæ¯
 * æ³¨æ„ï¼šä¸ä¼šåˆ é™¤å®Œæ•´å†å²ï¼Œå†å²ä¼šä¿ç•™å¹¶æ ‡è®°ä¸º excludedFromContext
 * @returns true è¡¨ç¤ºä¸Šä¸‹æ–‡ä¸­æ¶ˆæ¯è¢«åˆ é™¤ï¼Œfalse è¡¨ç¤ºæ¶ˆæ¯ä¸å­˜åœ¨
 */
removeMessageFromContext(sessionId: string, messageId: string, reason?: ContextExclusionReason): Promise<boolean>;
```

**æ”¹è¿›å»ºè®®**:
```typescript
// æ·»åŠ æ¶æ„å†³ç­–è®°å½• (ADR)
// docs/adr/001-memory-architecture.md

// æ·»åŠ æ€§èƒ½ç‰¹å¾æ–‡æ¡£
/**
 * æ€§èƒ½ç‰¹å¾ï¼š
 * - è¯»å–ï¼šO(1) ç¼“å­˜å‘½ä¸­ï¼ŒO(n) ç¼“å­˜æœªå‘½ä¸­
 * - å†™å…¥ï¼šO(1) ä½†å—æ–‡ä»¶ I/O é˜Ÿåˆ—é™åˆ¶
 * - å†…å­˜ï¼šO(æ‰€æœ‰æ•°æ®) å…¨é‡ç¼“å­˜
 */
```

### 7.3 æµ‹è¯•è¦†ç›–ç‡ â­â­â­ (3/5)

**å½“å‰æµ‹è¯•æ–‡ä»¶**:
| æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–èŒƒå›´ |
|---|---|---|
| `factory.test.ts` | 6 | å·¥å‚åˆ›å»ºé€»è¾‘ |
| `atomic-json.test.ts` | 3 | åŸå­å†™å…¥å’Œæ¢å¤ |
| `file-store-bundle.contract.test.ts` | - | æ¥å£å¥‘çº¦æµ‹è¯• |
| `hybrid-store-bundle.contract.test.ts` | - | æ··åˆå­˜å‚¨å¥‘çº¦æµ‹è¯• |
| `memory-orchestrator.race.test.ts` | - | å¹¶å‘æµ‹è¯• |
| `file-memory.persistence.test.ts` | - | æŒä¹…åŒ–æµ‹è¯• |
| `mongodb-memory.persistence.test.ts` | - | MongoDB æŒä¹…åŒ–æµ‹è¯• |

**ç¼ºå¤±çš„æµ‹è¯•**:
```typescript
// 1. Service å±‚å•å…ƒæµ‹è¯•
describe('SessionContextService', () => {
    it('should handle concurrent context updates');
    it('should recover from store failures');
});

// 2. è¾¹ç•Œæ¡ä»¶æµ‹è¯•
describe('MemoryOrchestrator', () => {
    it('should handle 10000+ sessions');
    it('should handle messages with 1MB+ content');
});

// 3. é›†æˆæµ‹è¯•
describe('MemoryManager Integration', () => {
    it('should survive process restart');
    it('should handle disk full scenarios');
});
```

**æ”¹è¿›å»ºè®®**:
```typescript
// æ·»åŠ è¦†ç›–ç‡ç›®æ ‡
// vitest.config.ts
export default {
    test: {
        coverage: {
            thresholds: {
                global: {
                    branches: 80,
                    functions: 80,
                    lines: 80,
                    statements: 80
                }
            }
        }
    }
}
```

---

## 8. é—®é¢˜æ¸…å•ä¸ä¿®å¤å»ºè®®

### ğŸ”´ ä¸¥é‡é—®é¢˜ (P0)

| ç¼–å· | ä½ç½® | é—®é¢˜æè¿° | é£é™© | å»ºè®®ä¿®å¤ |
|------|------|---------|------|---------|
| P1 | `session-context-service.ts:30-32` | `createSession` æ£€æŸ¥ååˆ›å»ºéåŸå­ï¼Œå¹¶å‘æ—¶å¯èƒ½é‡å¤åˆ›å»º | æ•°æ®ä¸ä¸€è‡´ | ä½¿ç”¨åˆ†å¸ƒå¼é”æˆ–æ•°æ®åº“å”¯ä¸€çº¦æŸ |
| P2 | `memory-orchestrator.ts:133-139` | `ensureInitialized()` åŒæ­¥æ£€æŸ¥ï¼Œå¼‚æ­¥åˆå§‹åŒ–æœªå®Œæˆæ—¶è°ƒç”¨ä¼šæŠ›é”™ | è¿è¡Œæ—¶é”™è¯¯ | æ‰€æœ‰å…¬å…±æ–¹æ³•åº”è°ƒç”¨ `waitForInitialization()` |

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

| ç¼–å· | ä½ç½® | é—®é¢˜æè¿° | é£é™© | å»ºè®®ä¿®å¤ |
|------|------|---------|------|---------|
| P3 | `session-context-service.ts:128-168` | `addMessageToContext` å¹¶è¡Œå†™å…¥æ— äº‹åŠ¡ä¿è¯ | æ•°æ®æŸå | å®ç°äº‹åŠ¡æˆ–é¡ºåºå†™å…¥ |
| P4 | `session-context-service.ts:237-305` | `compactContext` å¤šæ­¥éª¤æ“ä½œæ— é”ä¿æŠ¤ | æ•°æ®ä¸ä¸€è‡´ | æ·»åŠ ä¼šè¯çº§é” |
| P5 | `types.ts:232-252` | æ— è‡ªåŠ¨è¿‡æœŸ/TTL æœºåˆ¶ | å†…å­˜æ³„æ¼ | æ·»åŠ é…ç½®åŒ– TTL æ”¯æŒ |
| P6 | `bootstrap.ts:43-104` | `repairLoadedData` ä¿®å¤é€»è¾‘å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤± | æ•°æ®ä¸¢å¤± | å¢åŠ ä¿®å¤å‰å¤‡ä»½ |

### ğŸŸ¢ è½»å¾®é—®é¢˜ (P2)

| ç¼–å· | ä½ç½® | é—®é¢˜æè¿° | å½±å“ | å»ºè®®ä¿®å¤ |
|------|------|---------|------|---------|
| P7 | `atomic-json.ts:78-95` | `renameWithRetry` ä»…å¤„ç† EPERMï¼Œå…¶ä»–é”™è¯¯ç›´æ¥æŠ›å‡º | å¯æ¢å¤é”™è¯¯å¤±è´¥ | æ‰©å±•é‡è¯•æ¡ä»¶ |
| P8 | `domain/helpers.ts:62-74` | `upsertHistoryMessage` åºåˆ—å·å¯èƒ½å†²çª | æ¶ˆæ¯è¦†ç›– | ä½¿ç”¨å•è°ƒé€’å¢è®¡æ•°å™¨ |
| P9 | `task-service.ts:17-21` | Task ID å†²çªæ£€æŸ¥ä»…åŸºäºç¼“å­˜ | ID å†²çª | å¢åŠ æŒä¹…å±‚æ£€æŸ¥ |
| P10 | `memory-orchestrator.ts:58-63` | `close()` ç­‰å¾…åˆå§‹åŒ–ä½†å¿½ç•¥é”™è¯¯ | èµ„æºæ³„æ¼ | æ˜ç¡®é”™è¯¯å¤„ç†ç­–ç•¥ |

---

## 9. æ”¹è¿›è·¯çº¿å›¾

### é˜¶æ®µä¸€ï¼šç´§æ€¥ä¿®å¤ (1-2 å‘¨)

**ç›®æ ‡**: è§£å†³ä¸¥é‡é—®é¢˜ï¼Œæ¶ˆé™¤æ•°æ®ä¸ä¸€è‡´é£é™©

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|---------|
| ä¿®å¤ `createSession` ç«æ€æ¡ä»¶ | P0 | 4h |
| ä¿®å¤ `ensureInitialized` å¼‚æ­¥é—®é¢˜ | P0 | 2h |
| æ·»åŠ  `compactContext` é”æœºåˆ¶ | P1 | 4h |
| æ·»åŠ  `addMessageToContext` äº‹åŠ¡ä¿è¯ | P1 | 6h |

### é˜¶æ®µäºŒï¼šæ€§èƒ½ä¼˜åŒ– (2-3 å‘¨)

**ç›®æ ‡**: æå‡å¤§æ•°æ®é‡ä¸‹çš„æ€§èƒ½è¡¨ç°

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|---------|
| å®ç° LRU ç¼“å­˜æ·˜æ±°æœºåˆ¶ | P1 | 8h |
| å®ç°æ‡’åŠ è½½ç­–ç•¥ | P1 | 8h |
| æ·»åŠ æ‰¹é‡å†™å…¥ä¼˜åŒ– | P2 | 6h |
| æ·»åŠ å†…å­˜ç›‘æ§å’Œå‘Šè­¦ | P2 | 4h |

### é˜¶æ®µä¸‰ï¼šå®‰å…¨åŠ å›º (2-3 å‘¨)

**ç›®æ ‡**: æå‡æ•°æ®å®‰å…¨æ€§ï¼Œæ»¡è¶³ç”Ÿäº§ç¯å¢ƒè¦æ±‚

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|---------|
| å®ç°é™æ€æ•°æ®åŠ å¯† | P1 | 12h |
| æ·»åŠ æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶ | P1 | 6h |
| MongoDB TLS é…ç½®æ”¯æŒ | P2 | 4h |
| æ•æ„Ÿå­—æ®µæ ‡è®°å’Œè¿‡æ»¤ | P2 | 6h |

### é˜¶æ®µå››ï¼šæ¶æ„ä¼˜åŒ– (3-4 å‘¨)

**ç›®æ ‡**: æå‡å¯æ‰©å±•æ€§å’Œä»£ç è´¨é‡

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|---------|
| å¼•å…¥ Repository æ¨¡å¼ | P2 | 12h |
| å®ç°æ’ä»¶æ³¨å†Œè¡¨æœºåˆ¶ | P2 | 10h |
| æå–æ³›å‹åŸºç¡€ Store ç±» | P3 | 8h |
| å¢åŠ  Service å±‚å•å…ƒæµ‹è¯• | P2 | 16h |
| æ·»åŠ æ¶æ„å†³ç­–è®°å½• (ADR) | P3 | 4h |

---

## é™„å½•

### A. å…¬å…± API æ–¹æ³•æ¸…å•

| æ–¹æ³• | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| `createSession()` | â­â­â­ | åˆ›å»ºä¼šè¯åŠå…³è”æ•°æ® |
| `getSession()` | â­ | è·å–ä¼šè¯ä¿¡æ¯ |
| `querySessions()` | â­â­ | æŸ¥è¯¢ä¼šè¯åˆ—è¡¨ (æ”¯æŒè¿‡æ»¤/åˆ†é¡µ) |
| `getCurrentContext()` | â­ | è·å–å½“å‰ä¸Šä¸‹æ–‡ |
| `saveCurrentContext()` | â­â­ | ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ |
| `addMessageToContext()` | â­â­â­ | æ·»åŠ æ¶ˆæ¯åˆ°ä¸Šä¸‹æ–‡å’Œå†å² |
| `updateMessageInContext()` | â­â­â­ | æ›´æ–°æ¶ˆæ¯ |
| `removeMessageFromContext()` | â­â­â­ | ä»ä¸Šä¸‹æ–‡ç§»é™¤æ¶ˆæ¯ |
| `clearContext()` | â­â­ | æ¸…ç©ºä¸Šä¸‹æ–‡ |
| `compactContext()` | â­â­â­â­ | å‹ç¼©ä¸Šä¸‹æ–‡ (é«˜å¤æ‚åº¦) |
| `getFullHistory()` | â­â­ | è·å–å®Œæ•´å†å² |
| `getCompactionRecords()` | â­ | è·å–å‹ç¼©è®°å½• |
| `saveTask()` | â­â­ | ä¿å­˜ä»»åŠ¡ |
| `getTask()` | â­ | è·å–ä»»åŠ¡ |
| `queryTasks()` | â­â­ | æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨ |
| `deleteTask()` | â­â­ | åˆ é™¤ä»»åŠ¡ |
| `saveSubTaskRun()` | â­â­ | ä¿å­˜å­ä»»åŠ¡è¿è¡Œ |
| `getSubTaskRun()` | â­ | è·å–å­ä»»åŠ¡è¿è¡Œ |
| `querySubTaskRuns()` | â­â­ | æŸ¥è¯¢å­ä»»åŠ¡è¿è¡Œåˆ—è¡¨ |
| `deleteSubTaskRun()` | â­â­ | åˆ é™¤å­ä»»åŠ¡è¿è¡Œ |
| `initialize()` | â­â­ | åˆå§‹åŒ–å­˜å‚¨ |
| `close()` | â­â­ | å…³é—­å­˜å‚¨ |
| `waitForInitialization()` | â­ | ç­‰å¾…åˆå§‹åŒ–å®Œæˆ |

### B. æ”¯æŒçš„å­˜å‚¨åç«¯

| ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|-----|------|------|
| `file` | Ready | æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒé»˜è®¤ |
| `mongodb` | Ready | MongoDB æ–‡æ¡£å­˜å‚¨ |
| `hybrid` | Ready | æ··åˆå­˜å‚¨ï¼ˆçŸ­/ä¸­/é•¿æœŸåˆ†å±‚ï¼‰ |
| `mysql` | Planned | è®¡åˆ’ä¸­çš„å…³ç³»å‹å­˜å‚¨ |
| `redis` | Planned | è®¡åˆ’ä¸­çš„ç¼“å­˜å­˜å‚¨ |

### C. åˆ†æå‚ä¸æ™ºèƒ½ä½“

| æ™ºèƒ½ä½“ | èŒè´£ | è¾“å‡º |
|-------|------|------|
| Explore Agent | ä»£ç ç»“æ„æ¢ç´¢ | æ–‡ä»¶åˆ—è¡¨ã€ç±»å±‚æ¬¡ã€ä¾èµ–å…³ç³» |
| General-purpose Agent | æ ¸å¿ƒå®ç°åˆ†æ | æ•°æ®æµã€ç”Ÿå‘½å‘¨æœŸã€é”™è¯¯å¤„ç† |
| Code-reviewer Agent | æ¶æ„è®¾è®¡è¯„ä¼° | æ€§èƒ½ã€å®‰å…¨æ€§ã€ä»£ç è´¨é‡è¯„ä¼° |

---

**æŠ¥å‘Šç»“æŸ**

*æœ¬æŠ¥å‘Šç”±å¤šæ™ºèƒ½ä½“åä½œç”Ÿæˆï¼Œåˆ†æåŸºäºé¡¹ç›®å½“å‰ä»£ç çŠ¶æ€ã€‚å»ºè®®å®šæœŸé‡æ–°è¯„ä¼°ä»¥è·Ÿè¸ªæ”¹è¿›è¿›åº¦ã€‚*
