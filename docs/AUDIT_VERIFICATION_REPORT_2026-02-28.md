# Coding Agent å®¡è®¡é—®é¢˜ä¼˜åŒ–æŠ¥å‘Š

**ç”Ÿæˆæ—¥æœŸ**: 2026-02-28  
**çŠ¶æ€**: å·²å®Œæˆå…³é”®é—®é¢˜ä¿®å¤

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šè®°å½•äº†å¯¹ä¸‰ä»½å®¡è®¡æ–‡æ¡£ä¸­æåˆ°é—®é¢˜çš„ä¿®å¤æƒ…å†µã€‚éµå¾ª**é€‚åº¦ä¼˜åŒ–åŸåˆ™**ï¼Œä¿®å¤äº†å…³é”®çš„å®‰å…¨å’Œé€»è¾‘é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒä»£ç ç®€æ´æ€§ã€‚

### ä¿®å¤æ¦‚è§ˆ

| é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| P0-1 hasContent ç©ºå€¼æ£€æŸ¥ | âœ… å·²ä¿®å¤ | å¢å¼ºäº†å†…å®¹æ£€æŸ¥é€»è¾‘ |
| P0-2 isRetryExceeded æ¡ä»¶ | â¸ï¸ ä¿æŒåŸé€»è¾‘ | ç»åˆ†æï¼ŒåŸè¯­ä¹‰æ­£ç¡® |
| P0-3 KimiAdapter å‚æ•° | âœ… å·²ä¿®å¤ | é€ä¼ æ„é€ å‚æ•° |
| P0-4 æˆªæ–­é…ç½®å·¥å…·å | âœ… å·²ä¿®å¤ | `read` æ”¹ä¸º `read_file` |
| P0-5 Plan æ¨¡å¼ç»•è¿‡ | â¸ï¸ æš‚ç¼“ | éœ€è¦æ¶æ„è®¾è®¡ï¼Œå·²è®°å½• |
| P0-6 WebFetch SSRF é˜²æŠ¤ | âœ… å·²ä¿®å¤ | æ·»åŠ å†…ç½‘åœ°å€æ£€æµ‹ |
| P0-7 LSP å†…å­˜æ³„æ¼ | â¸ï¸ æš‚ç¼“ | éœ€è¦æ›´å¤šè®¾è®¡ï¼Œå·²æœ‰æ‰‹åŠ¨æ¸…ç† |

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. hasContent ç©ºå€¼æ£€æŸ¥å¢å¼º

**æ–‡ä»¶**: `src/agent-v2/agent/core-types.ts`

**ä¿®æ”¹å†…å®¹**: å¢å¼ºäº† `hasContent` å‡½æ•°ï¼Œæ­£ç¡®æ£€æŸ¥æ–‡æœ¬å†…å®¹æ˜¯å¦ä¸ºç©ºã€‚

```typescript
// ä¿®å¤åçš„ä»£ç 
export function hasContent(content: MessageContent): boolean {
    if (content == null) return false;
    if (typeof content === 'string') {
        return content.length > 0;
    }
    if (!Array.isArray(content) || content.length === 0) {
        return false;
    }
    return content.some((part) => {
        if (part.type === 'text') {
            return (part.text ?? '').length > 0;
        }
        return true; // éæ–‡æœ¬ç±»å‹è§†ä¸ºæœ‰å†…å®¹
    });
}
```

---

### 2. isRetryExceeded è¯­ä¹‰è¯´æ˜ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰

**æ–‡ä»¶**: `src/agent-v2/agent/core/agent-state.ts`

**åˆ†æç»“æœ**: ç»æ·±å…¥åˆ†æï¼ŒåŸé€»è¾‘ `>` æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºï¼š

- `maxRetries` è¡¨ç¤º"å…è®¸çš„æœ€å¤§**é‡è¯•**æ¬¡æ•°"ï¼Œä¸æ˜¯"æœ€å¤§è°ƒç”¨æ¬¡æ•°"
- `maxRetries=3` æ„å‘³ç€ç¬¬ä¸€æ¬¡è°ƒç”¨å¤±è´¥åï¼Œæœ€å¤šå¯ä»¥é‡è¯• 3 æ¬¡
- ä½¿ç”¨ `>` é€»è¾‘ï¼š
  - `retryCount=0` æ—¶ï¼Œ`0 > 3 = false`ï¼Œå¯ä»¥è°ƒç”¨
  - `retryCount=1` æ—¶ï¼Œ`1 > 3 = false`ï¼Œå¯ä»¥é‡è¯•
  - `retryCount=2` æ—¶ï¼Œ`2 > 3 = false`ï¼Œå¯ä»¥é‡è¯•
  - `retryCount=3` æ—¶ï¼Œ`3 > 3 = false`ï¼Œå¯ä»¥é‡è¯•
  - `retryCount=4` æ—¶ï¼Œ`4 > 3 = true`ï¼Œè¶…è¿‡é™åˆ¶

```typescript
// ä¿æŒåŸé€»è¾‘ï¼ˆè¯­ä¹‰æ­£ç¡®ï¼‰
isRetryExceeded(): boolean {
    return this._retryCount > this.config.maxRetries;
}
```

---

### 3. KimiAdapter æ„é€ å‚æ•°é€ä¼ 

**æ–‡ä»¶**: `src/providers/adapters/kimi.ts`

**ä¿®æ”¹å†…å®¹**: å°†æ„é€ å‚æ•°é€ä¼ åˆ°çˆ¶ç±»ã€‚

```typescript
// ä¿®å¤åçš„ä»£ç 
export class KimiAdapter extends StandardAdapter {
    constructor(options: { endpointPath?: string; defaultModel?: string } = {}) {
        super(options);
    }
}
```

---

### 4. æˆªæ–­é…ç½®å·¥å…·åä¿®æ­£

**æ–‡ä»¶**: `src/agent-v2/truncation/constants.ts`

**ä¿®æ”¹å†…å®¹**: å°† `read` æ”¹ä¸º `read_file`ã€‚

```typescript
// ä¿®å¤åçš„ä»£ç 
export const TOOL_TRUNCATION_CONFIGS: Record<string, Partial<TruncationConfig>> = {
    read_file: {  // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„å·¥å…·å
        enabled: false,
    },
    // ...
};
```

---

### 5. WebFetch SSRF é˜²æŠ¤

**æ–‡ä»¶**: `src/agent-v2/tool/web-fetch.ts`

**ä¿®æ”¹å†…å®¹**: æ·»åŠ äº†å†…ç½‘åœ°å€å’Œæ•æ„Ÿåœ°å€çš„æ£€æµ‹ã€‚

```typescript
// æ·»åŠ çš„ SSRF é˜²æŠ¤
const BLOCKED_HOST_PATTERNS: RegExp[] = [
    // localhost å’Œå›ç¯åœ°å€
    /^(localhost|127\.0\.0\.1|0\.0\.0\.0|\[::1\])$/i,
    // å†…ç½‘ IP
    /^10\./,
    /^172\.(1[6-9]|2[0-9]|3[0-1])\./,
    /^192\.168\./,
    // é“¾è·¯æœ¬åœ°å’Œäº‘å…ƒæ•°æ®åœ°å€
    /^169\.254\./,
    /^(metadata\.google\.internal|metadata\.azure)$/i,
];

function isBlockedAddress(url: string): { blocked: boolean; reason?: string } {
    // ... æ£€æµ‹é€»è¾‘
}
```

---

## â¸ï¸ æš‚ç¼“ä¿®å¤çš„é—®é¢˜

### P0-5: Plan æ¨¡å¼å®‰å…¨ç»•è¿‡é£é™©

**åŸå› **: éœ€è¦æ›´æ·±å…¥çš„æ¶æ„è®¾è®¡ï¼Œå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½ã€‚

**å»ºè®®æ–¹æ¡ˆ**:
1. åœ¨ Plan æ¨¡å¼ä¸‹é™åˆ¶ `task` çš„ `subagent_type`
2. æˆ–è€…å®Œå…¨ç¦ç”¨ `task` å·¥å…·

**è®°å½•ä½ç½®**: `src/agent-v2/__tests__/audit-verification.test.ts`

---

### P0-7: LSP å†…å­˜æ³„æ¼é£é™©

**åŸå› **: éœ€è¦æ›´å¤æ‚çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶è®¾è®¡ã€‚

**å½“å‰çŠ¶æ€**: å·²æœ‰æ‰‹åŠ¨æ¸…ç†æ–¹æ³• `LspTool.clearCache()`

**å»ºè®®æ–¹æ¡ˆ**: æ·»åŠ åŸºäºæ—¶é—´æˆ– LRU çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶

---

## ğŸ“Š æµ‹è¯•çŠ¶æ€

### å…¨é‡æµ‹è¯•

```bash
pnpm test:run
```

**ç»“æœ**: âœ… **962/962 é€šè¿‡**

### éªŒè¯æµ‹è¯•

```bash
pnpm test src/agent-v2/__tests__/audit-verification.test.ts
```

**ç»“æœ**: âœ… **24/24 é€šè¿‡**

### CI æ£€æŸ¥

- âœ… `pnpm typecheck` - é€šè¿‡
- âœ… `pnpm lint` - é€šè¿‡

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ |
|------|----------|
| `src/agent-v2/agent/core-types.ts` | åŠŸèƒ½å¢å¼º |
| `src/providers/adapters/kimi.ts` | Bug ä¿®å¤ |
| `src/agent-v2/truncation/constants.ts` | é…ç½®ä¿®æ­£ |
| `src/agent-v2/tool/web-fetch.ts` | å®‰å…¨å¢å¼º |
| `src/agent-v2/__tests__/audit-verification.test.ts` | æ–°å¢æµ‹è¯• |

---

## ğŸ“ è®¾è®¡å†³ç­–è¯´æ˜

### isRetryExceeded ä¿æŒåŸé€»è¾‘

å®¡è®¡æŠ¥å‘Šå»ºè®®å°† `>` æ”¹ä¸º `>=`ï¼Œä½†ç»æ·±å…¥åˆ†æå‘ç°ï¼š

1. **è¯­ä¹‰æ­£ç¡®æ€§**: `maxRetries` è¡¨ç¤º"æœ€å¤§é‡è¯•æ¬¡æ•°"ï¼Œä¸æ˜¯"æœ€å¤§è°ƒç”¨æ¬¡æ•°"
   - `maxRetries=3` = ç¬¬ä¸€æ¬¡è°ƒç”¨ + æœ€å¤š 3 æ¬¡é‡è¯•
   - ç¬¬ä¸€æ¬¡è°ƒç”¨ä¸ç®—"é‡è¯•"

2. **è¾¹ç•Œæƒ…å†µ**: 
   - `maxRetries=0` æ—¶ï¼Œä½¿ç”¨ `>` é€»è¾‘å…è®¸ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥åä¸é‡è¯•
   - ä½¿ç”¨ `>=` ä¼šå¯¼è‡´ç¬¬ä¸€æ¬¡è°ƒç”¨å‰å°±æŠ›å‡ºé”™è¯¯

3. **æµ‹è¯•éªŒè¯**: 
   - åŸæœ‰ 962 ä¸ªæµ‹è¯•ç”¨ä¾‹éªŒè¯äº†æ­¤è¯­ä¹‰çš„æ­£ç¡®æ€§
   - æ”¹ä¸º `>=` ä¼šå¯¼è‡´ 26+ ä¸ªæµ‹è¯•å¤±è´¥

**ç»“è®º**: ä¿æŒ `>` é€»è¾‘ï¼Œè¿™æ˜¯æ­£ç¡®çš„è¯­ä¹‰ã€‚

---

## ğŸ¯ åç»­å·¥ä½œå»ºè®®

### çŸ­æœŸï¼ˆ1-2 å¤©ï¼‰
1. å¤„ç† P0-5 Plan æ¨¡å¼å®‰å…¨é—®é¢˜
2. å¤„ç† P1-1 CLI ä¼šè¯å·å±•ç¤º

### ä¸­æœŸï¼ˆ1 å‘¨ï¼‰
1. æ·»åŠ  LSP è‡ªåŠ¨æ¸…ç†æœºåˆ¶
2. ç»Ÿä¸€è¶…æ—¶é…ç½®å±æ€§
3. å¤„ç†å…¶ä»– P1 çº§åˆ«é—®é¢˜

### é•¿æœŸ
1. ä»£ç è´¨é‡æŒç»­æ”¹è¿›
2. å®Œå–„æµ‹è¯•è¦†ç›–ç‡

---

*æŠ¥å‘Šç»“æŸ*
