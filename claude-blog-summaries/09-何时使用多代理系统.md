# 何时使用多代理系统（以及何时不使用）

**发布日期**：2026年1月23日  
**分类**：代理  
**产品**：Claude 开发者平台  
**阅读时间**：5 分钟

## 概述

虽然单个代理系统可以有效地处理大多数企业工作流，但多代理架构可以为你的组织解锁额外价值。了解何时以及如何使用它们。

## 为什么单个代理通常是更好的起点

单个代理配合适当的工具可以完成的工作远超许多开发者的预期。

多代理系统引入了开销：
- 每个额外的代理都代表另一个潜在的故障点
- 另一组需要维护的提示
- 以及意外行为的另一个来源

Anthropic 观察到团队花费数月构建复杂的多代理架构，只是发现改进单个代理的提示可以实现同等结果。

在测试中，多代理实现通常为等效任务使用的代币是单个代理方法的 3-10 倍。这种开销来自于：
- 在代理之间重复上下文
- 协调代理之间的消息
- 为交接总结结果

## 使用多代理系统的决策框架

多代理架构应仅用于解决单个代理无法克服的具体约束并提供明确的额外成本优势以证明其合理性的情况。

以下模式代表我们始终观察到积极投资回报的情况：

### 1. 上下文保护

大型语言模型具有有限的上下文窗口，随着上下文增长，响应质量会下降。当一个代理的上下文积累了来自一个子任务、与后续子任务无关的信息时，就会出现上下文污染。

子代理提供隔离，每个代理在其专注于自身特定任务的干净上下文中运行。

**示例：客户支持代理**
如果一个代理需要检索订单历史记录同时诊断技术问题。如果每次订单查找都向上下文添加数千个代币，代理推理技术问题的能力就会下降。

**单个代理方法**：
```javascript
// 单个代理在上下文中累积所有信息
conversation_history = [
    { "role": "user", "content": "我的订单 #12345 不工作" },
    { "role": "assistant", "content": "让我检查你的订单..." },
    // 工具结果向上下文添加 2000+ 个代币的订单历史
    { "role": "user", "content": "... (订单详情、过往购买、配送信息) ..." },
    { "role": "assistant", "content": "现在让我诊断技术问题..." },
    // 上下文现在被代理不需要的订单详情污染，稀释注意力并降低响应质量
]
```

**多代理方法**：
```javascript
// 每个子代理都有自己独立的上下文
// 订单查找代理仅检索它实际需要的内容，而非完整历史
// 向主代理注入紧凑摘要，而非完整上下文
```

上下文隔离在子任务生成高上下文量（超过 1000 个代币）、但该信息的大部分与主任务无关时最有效。

### 2. 并行化

同时运行多个代理允许你探索比单个代理可以覆盖的更大搜索空间。这种模式在搜索和研究任务中已被证明具有特别价值的价值。

Anthropic 的研究功能使用了这种方法。一个领导代理分析查询并生成多个子代理并行调查查询的不同方面。每个子代理独立搜索，然后返回精炼的发现。多代理搜索显示出比单个代理方法在搜索准确性方面有实质性提升。

核心实现将问题分解为独立的方面，并行运行子代理，然后综合结果。

```javascript
// 领导代理将查询分解为研究方面
// 并行运行子代理独立调查每个方面
```

这种改进覆盖带来了成本。多代理系统通常比等效任务的单一代理方法消耗 3-10 倍更多的代币。这是由于每个代理都需要自己的上下文、代理必须交换消息以协调，并且必须在代理之间总结结果。

并行化的主要好处是全面性，而不是速度。当你需要在大型信息空间中搜索或调查复杂问题的多个角度时，并行代理可以覆盖比单个代理在其上下文限制内更多的地面。

### 3. 专业化

不同的任务有时受益于不同的工具集、系统提示或专业知识域。而不是为单个代理提供数十个工具，配备与其职责匹配的聚焦工具集的专用代理可以提高可靠性。

#### 工具集专业化
当一个代理有太多工具（通常 20+ 个）时，性能会受到损害。三个信号表明工具专业化会有所帮助：
1. **数量**：拥有太多工具的代理经常难以选择合适的工具
2. **领域混淆**：当工具跨越多个不相关领域时，代理会困惑哪个域适用于给定任务
3. **性能下降**：添加新工具会降低现有任务的性能，表明代理已达到其工具管理能力

#### 系统提示专业化
不同任务有时需要不同的人格、约束或指令，当组合时会产生冲突。客户支持代理需要富有同理心和耐心；代码审查代理需要精确和批判；合规检查代理需要严格的规则遵守；头脑风暴代理需要创造性的灵活性。

当一个单一代理必须在冲突的行为模式之间切换时，分离为具有定制系统提示的专用代理会产生更一致的结果。

#### 领域专业知识专业化
某些任务受益于会压倒通用代理的深度领域上下文。法律分析代理可能需要大量关于判例法和监管框架的上下文；医学研究代理可能需要关于临床试验方法学的专业知识；而不是将所有域上下文加载到单个代理中，专用代理可以承载与其特定职责相关的聚焦专业知识。

### 验证子代理模式

一个始终在跨域中运行良好的多代理模式是**验证子代理**。这是一个专用于测试或验证主代理工作的专用代理。

验证子代理成功是因为它们避开了"电话游戏"问题。验证本质上只需要最少的上下文传输，因此验证者可以在不了解工件如何构建的情况下黑盒测试系统。

## 上下文中心分解

采用多代理架构时，最重要的设计决策是如何在代理之间分配工作。我们观察到团队经常做出错误的决定，导致协调开销抵消了多代理设计的好处。

关键见解是采用**以上下文为中心的视图**而不是以问题为中心的视图来分解工作。

### 问题中心分解（通常适得其反）
按工作类型划分（一个代理编写功能，另一个编写测试，第三个审查代码）会产生持续的协调开销。每次交接都会丢失上下文。测试编写代理缺乏了解某些实现决策为何被做出的背景，代码审查代理缺乏探索和迭代的上下文。

### 上下文中心分解（通常有效）
按上下文边界划分意味着处理功能的代理也应该处理其测试，因为它已经拥有必要的上下文。工作仅应在上下文可以真正隔离时才分割。

**有效的分解边界包括**：
- **独立研究路径**：调查"亚洲的市场趋势"与"欧洲的市场趋势"可以毫无共享上下文地并行进行
- **具有清晰接口的分离组件**：在明确定义的 API 契约下，前端和后端工作可以并行进行
- **黑盒验证**：只需运行测试并报告结果的验证者不需要实现上下文

**问题化的分解边界包括**：
- **相同工作的顺序阶段**：规划、实现和测试同一功能共享过多的上下文
- **紧密耦合的组件**：需要持续来回沟通的组件应该属于同一代理
- **需要共享状态的工作**：需要频繁同步理解的代理应该保持在一起

## 向前推进

超出一般框架，某些具体信号表明单个代理模式已被超越：

### 接近上下文限制
如果一个代理经常使用大量上下文且性能正在下降，上下文压力可能成为瓶颈。请注意，上下文管理方面的最新进步（如压缩）正在减少这一限制，允许单个代理在更长的范围内保持有效的记忆。

### 管理许多工具
当一个代理有 15-20+ 个工具时，模型花费大量上下文和注意力来理解其选项。在采用多代理架构之前，考虑使用[工具搜索工具](https://docs.anthropic.com/en/docs/agents-and-tools/tool-use/tool-search-tool)，这让 Claude 可以动态地按需发现工具，而不是预先加载所有定义。这可以[将代币使用量减少多达 85%](https://www.anthropic.com/engineering/advanced-tool-use)，同时提高工具选择的准确性。

### 可并行化的子任务
当任务自然分解为独立片段时，并行子代理可以提供实质性的加速。

这些阈值将随着模型的改进而转移。当前的限度代表实际指南，而非根本约束。

## 避免多代理架构的常见错误

### 过度复杂
许多团队在看到多代理系统中的失败，原因是分解错误。每个代理都在处理一个片段，但每个都进行自己的版本：

**场景**：一个代理更新财务模型
- 代理 A：更新收入、调整费用、预测收入
- 代理 B：更新竞争对手数据、更新估值
- 代理 C：更新预算分配
- 问题：缺乏协调，不同代理使用相互冲突的假设

**失败模式**："电话游戏"效应
代理 A 传递给代理 B，代理 B 传回给代理 A，反复来回。每次交接都丢失上下文并降低质量。

**更好的方法**：将更新分为有清晰接口的独立阶段
- 财务模型：独立负责收入和预测
- 竞争对手分析：独立负责市场数据
- 预算：独立负责预算分配
- 协调器：统一版本控制和分配

### 未充分利用单一代理优势
- 忽略简单解决方案：直接构建多代理系统，而不是优化单个代理
- 不验证必要性：没有评估单个代理是否能真正受益
- 过早扩展：在证明价值之前增加不必要的复杂性

## 建议

1. 从最简单、有效的方法开始
2. 仅在多代理确实解决了真正的约束时才添加复杂性
3. 确保分解遵循上下文，而非问题类型
4. 保持验证明确、具体的标准

## 相关资源

- [构建有效的代理](https://www.anthropic.com/engineering/building-effective-agents)
- [AI 代理的有效上下文工程](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents)
- [Anthropic 多代理研究系统](https://www.anthropic.com/engineering/multi-agent-research-system)

## 总结

多代理系统功能强大，但并非普遍适用。在添加多个协调代理的复杂性之前，确认：
1. 存在真实的多代理能解决的具体约束
2. 分解遵循上下文，而非问题类型
3. 存在明确的验证点

我们的建议？从最简单、有效的方法开始，并在证据支持其合理性时才添加复杂性。
